<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NovaChat | Accesso</title>
  <style>
    
    .hidden {
  display: none !important;
}

    :root {
      --bg: #0d0f17;
      --panel: rgba(20, 23, 35, 0.72);
      --panel-strong: rgba(29, 32, 47, 0.85);
      --text: #f5f6ff;
      --muted: #c3c7d8;
      --accent: #9d6bff;
      --accent-2: #5cf0ff;
      --danger: #ff6b9b;
      --success: #8df7c5;
      --border: rgba(255, 255, 255, 0.06);
      --glow: 0 16px 40px rgba(111, 111, 255, 0.35);
      --card-radius: 20px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif;
    }

    body {
      min-height: 100vh;
      background:
        radial-gradient(circle at 20% 20%, rgba(157, 107, 255, 0.24), transparent 40%),
        radial-gradient(circle at 80% 15%, rgba(92, 240, 255, 0.2), transparent 32%),
        radial-gradient(circle at 50% 80%, rgba(255, 107, 155, 0.18), transparent 30%),
        var(--bg);
      color: var(--text);
      display: grid;
      place-items: center;
      padding: 32px 16px;
      overflow: hidden;
      position: relative;
      isolation: isolate;
    }

    .grain {
      position: fixed;
      inset: 0;
      opacity: 0.26;
      pointer-events: none;
      background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="160" height="160" viewBox="0 0 160 160"><filter id="n"><feTurbulence type="fractalNoise" baseFrequency="0.8" numOctaves="4" stitchTiles="stitch"/></filter><rect width="160" height="160" filter="url(%23n)" opacity="0.55"/></svg>');
      mix-blend-mode: soft-light;
      z-index: -1;
    }

    .orb {
      position: absolute;
      width: 320px;
      height: 320px;
      border-radius: 50%;
      filter: blur(70px);
      opacity: 0.55;
      z-index: -1;
      animation: float 12s ease-in-out infinite alternate;
    }

    .orb.one { background: rgba(157, 107, 255, 0.4); top: -60px; left: -40px; animation-delay: 0.5s; }
    .orb.two { background: rgba(92, 240, 255, 0.4); top: 40%; right: -120px; animation-duration: 14s; }
    .orb.three { background: rgba(255, 107, 155, 0.38); bottom: -80px; left: 18%; animation-duration: 16s; }

    @keyframes float {
      from { transform: translateY(-12px) scale(1); }
      to { transform: translateY(16px) scale(1.05); }
    }

    .app-shell {
      position: relative;
      width: min(1200px, 96vw);
      animation: intro 0.9s ease forwards;
      opacity: 0;
      transform: translateY(16px) scale(0.98);
    }

    @keyframes intro {
      0% { opacity: 0; transform: translateY(18px) scale(0.97); filter: blur(6px); }
      60% { opacity: 1; transform: translateY(-4px) scale(1.005); filter: blur(0); }
      100% { opacity: 1; transform: translateY(0) scale(1); }
    }

    .card-wrap { width: min(440px, 96vw); margin: 0 auto; }

    .splash {
      position: absolute;
      inset: -30%;
      background: radial-gradient(circle at 50% 40%, rgba(157, 107, 255, 0.35), transparent 45%),
                  radial-gradient(circle at 40% 60%, rgba(92, 240, 255, 0.3), transparent 48%),
                  radial-gradient(circle at 65% 70%, rgba(255, 107, 155, 0.32), transparent 48%);
      filter: blur(50px) saturate(1.3);
      opacity: 0.55;
      z-index: 0;
      animation: splashDrift 9s ease-in-out infinite;
      transform-origin: 60% 40%;
      overflow: hidden;
    }
    @keyframes splashDrift {
      0% { transform: scale(1) rotate(0deg); }
      100% { transform: scale(1.15) rotate(8deg); }
    }

    .splash.burst {
      animation: splashBurst 0.5s ease forwards;
    }

    @keyframes splashBurst {
      0% { transform: scale(1) rotate(0deg); filter: blur(50px); }
      80% { transform: scale(1.3) rotate(5deg); filter: blur(30px); opacity: 0.85; }
      100% { transform: scale(1.15) rotate(8deg); filter: blur(40px); opacity: 0.55; }
    }

    .login-card,
    .main-view,
    .chat-view {
      background: var(--panel);
      backdrop-filter: blur(20px) saturate(1.7);
      border: 1px solid var(--border);
      border-radius: var(--card-radius);
      padding: 24px;
      position: relative;
      overflow: hidden;
      box-shadow: var(--glow);
    }

    h1 { text-align: center; font-size: 1.8rem; margin-bottom: 6px; }

    p.subtitle {
      text-align: center;
      margin-bottom: 24px;
      color: var(--muted);
      font-size: 0.95rem;
    }

    form { display: flex; flex-direction: column; gap: 16px; }

    label { font-size: 0.92rem; }

    .input-group {
      display: flex; flex-direction: column; gap: 6px;
    }

    .text-input {
      width: 100%;
      padding: 12px 14px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.04);
      color: var(--text);
      font-size: 1rem;
      outline: none;
      transition: 0.25s ease;
    }

    .text-input:focus {
      border-color: var(--accent);
      background: rgba(255,255,255,0.06);
      box-shadow: 0 0 0 2px rgba(157,107,255,0.2);
    }

    .stay-wrap {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: -4px;
    }

    .input-checkbox {
      width: 18px; height: 18px;
      cursor: pointer;
    }

    button {
      padding: 12px;
      font-size: 1rem;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      color: #fff;
      background: var(--accent);
      font-weight: 600;
      transition: background 0.25s ease, transform 0.15s ease;
    }

    button:hover { background: #8e59ff; }
    button:active { transform: scale(0.97); }

    .switch {
      margin-top: 8px;
      text-align: center;
      font-size: 0.92rem;
      color: var(--muted);
    }

    .switch button {
      background: none;
      color: var(--accent);
      border: none;
      padding: 0;
      font-size: 0.95rem;
      cursor: pointer;
    }

    .status {
      font-size: 0.9rem;
      height: 20px;
      margin-top: -6px;
      text-align: center;
      transition: 0.25s ease;
    }

    .status.success { color: var(--success); }
    .status.error { color: var(--danger); }

    /* MAIN layout */
    .main-view {
      display: grid;
      grid-template-columns: 260px 1fr;
      gap: 20px;
      min-height: 640px;
    }

    .sidebar {
      background: var(--panel-strong);
      border-radius: var(--card-radius);
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 20px;
      border: 1px solid var(--border);
    }

    .user-card {
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .avatar {
      width: 48px; height: 48px;
      border-radius: 14px;
      background: linear-gradient(145deg, var(--accent), var(--accent-2));
      display: grid;
      place-items: center;
      font-size: 1.3rem;
      font-weight: 700;
      color: #fff;
    }

    .user-info {
      display: flex; flex-direction: column;
      gap: 2px;
    }

    .username { font-size: 1.05rem; font-weight: 600; }
    .handle { font-size: 0.9rem; color: var(--muted); }

    .status-line { display: flex; align-items: center; gap: 6px; font-size: 0.9rem; }

    .dot {
      width: 10px; height: 10px;
      border-radius: 50%;
    }

    .dot.online { background: #6aff9b; }
    .dot.offline { background: #888; }
    .dot.blocked { background: var(--danger); }

    .filters {
      display: flex; gap: 8px;
    }

    .filters button {
      flex: 1;
      background: rgba(255,255,255,0.06);
      border: 1px solid var(--border);
      font-size: 0.9rem;
      padding: 8px;
    }

    .filters button.active {
      background: var(--accent);
      border-color: transparent;
    }

    .friend-list {
      flex: 1;
      overflow-y: auto;
      padding-right: 8px;
      margin-top: 4px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .friend-card {
      display: flex; align-items: center;
      background: rgba(255,255,255,0.04);
      border-radius: 14px;
      padding: 12px;
      cursor: pointer;
      border: 1px solid var(--border);
      transition: 0.25s ease;
      position: relative;
    }

    .friend-card:hover { background: rgba(255,255,255,0.07); }

    .friend-card .friend-meta {
      display: flex; flex-direction: column;
      margin-left: 12px;
      flex: 1;
    }

    .friend-card .friend-name { font-size: 1rem; font-weight: 600; margin-bottom: 4px; }

    .friend-card .friend-status {
      font-size: 0.82rem; color: var(--muted);
      display: flex; align-items: center; gap: 6px;
    }

    /* popup menu inside friend card */
    .friend-actions {
      position: relative;
      display: flex; align-items: center;
    }

    .action-btn {
      background: rgba(255,255,255,0.05);
      padding: 6px 10px;
      font-size: 1.1rem;
      border-radius: 8px;
    }

    .friend-actions .menu {
      position: absolute;
      right: 0;
      top: 120%;
      display: none;
      flex-direction: column;
      background: var(--panel);
      backdrop-filter: blur(16px);
      border-radius: 10px;
      padding: 6px;
      border: 1px solid var(--border);
      box-shadow: var(--glow);
      z-index: 5;
    }

    .friend-actions .menu button {
      background: none;
      border: none;
      text-align: left;
      padding: 8px 10px;
      font-size: 0.9rem;
      color: var(--text);
      width: 150px;
      border-radius: 8px;
      transition: 0.2s ease;
    }

    .friend-actions .menu button:hover {
      background: rgba(255,255,255,0.08);
    }

    .empty {
      text-align: center;
      padding: 36px 0;
      color: var(--muted);
      font-size: 0.95rem;
    }

    /* Main right panel */
    .main-panel {
      background: var(--panel-strong);
      border-radius: var(--card-radius);
      padding: 24px;
      border: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .search {
      display: flex; flex-direction: column; gap: 10px;
    }

    .search input {
      padding: 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.06);
      color: var(--text);
      font-size: 1rem;
    }

    .stats {
      display: flex; gap: 20px;
      font-size: 0.9rem;
      color: var(--muted);
    }

</style>
</head>

<body>
  <div class="grain"></div>
  <div class="orb one"></div>
  <div class="orb two"></div>
  <div class="orb three"></div>

  <div class="app-shell" id="app">

    <!-- ========================= -->
    <!--        AUTH VIEW         -->
    <!-- ========================= -->

    <section id="auth-view" class="card-wrap">
      <div class="splash" aria-hidden="true"></div>

      <div class="card login-card" role="main">
        
        <div class="logo" aria-hidden="true">
          <img src="Images/Logo.png" alt="Logo NovaChat" />
        </div>

        <h1 id="form-title">NovaChat</h1>
        <p class="subtitle" id="form-subtitle">
          Accedi o registra il tuo profilo con username e password: nessuna email richiesta.
        </p>

        <form id="auth-form">

          <div class="input-group">
            <label for="username">Username</label>
            <input id="username" class="text-input" name="username" autocomplete="username" required />
          </div>

          <div class="input-group">
            <label for="password">Password</label>
            <input id="password" class="text-input" type="password" name="password" autocomplete="current-password" required />
          </div>

          <label class="stay-wrap" for="stay-logged">
            <input type="checkbox" id="stay-logged" class="input-checkbox" checked />
            <span>Rimani connesso</span>
          </label>

          <button type="submit" id="submit-btn">Crea account</button>
          <div class="status" id="status"></div>

        </form>

        <div class="switch">
          <span id="switch-copy">Hai giÃ  un account?</span>
          <button id="switch-btn" type="button">Accedi</button>
        </div>

      </div>
    </section>
    <!-- ========================= -->
    <!--         MAIN VIEW        -->
    <!-- ========================= -->

    <section id="main-view" class="hidden">

      <div class="main-view">

        <!-- SIDEBAR -->
        <aside class="sidebar">

          <div class="brand user-card">
            <img src="Images/Logo.png" alt="NovaChat" style="width:42px;height:42px;border-radius:12px;">
            <div class="user-info">
              <div class="username" style="font-weight:700;">NovaChat</div>
            </div>
          </div>

          <div class="filters" id="filters">
            <button data-filter="all" class="active">All</button>
            <button data-filter="online">Online</button>
            <button data-filter="pending">Pending</button>
            <button data-filter="blocked">Blocked</button>
          </div>

          <div class="friend-list" id="friend-list"></div>

        </aside>

        <!-- MAIN PANEL -->
        <main class="main-panel">

          <div class="search">
            <input type="search" id="search" placeholder="Search">
            <button id="add-friend">Add Friend</button>
          </div>

          <div class="stats">
            <div>ONLINE: <span id="online-count">0</span></div>
            <div>OFFLINE: <span id="offline-count">0</span></div>
          </div>

        </main>

        <!-- SIDE PROFILE SUMMARY -->
        <aside class="panel side-profile">

          <div class="user-card">
            <div class="avatar" id="side-avatar">N</div>
            <div class="user-info">
              <div class="username" id="side-name">Nova User</div>
              <div class="handle" id="side-handle">@utente</div>
              <div class="status-line" id="side-status">
                <span class="dot online"></span> Online
              </div>
            </div>
          </div>

          <div style="margin:10px 0;font-size:0.9rem;">
            <strong id="member-since">Membro</strong>
          </div>

          <button id="side-add" style="width:100%;">Send Friend Request</button>
          <button id="open-profile" style="width:100%;margin-top:10px;">â‹¯ Profilo</button>

        </aside>

      </div>

    </section>
    <!-- ========================= -->
    <!--         CHAT VIEW        -->
    <!-- ========================= -->

    <section id="chat-view" class="hidden">

      <div class="chat-layout">

        <!-- CHAT AREA -->
        <div class="chat-panel">

          <!-- Header Chat -->
          <div class="chat-header">
            <img src="Images/Logo.png" id="back-to-main" style="cursor:pointer;width:40px;height:40px;border-radius:12px;">
            <div>
              <div class="friend-name" id="chat-name">Chat</div>
              <div class="friend-status" id="chat-status"></div>
            </div>
          </div>

          <!-- Messages -->
          <div class="messages" id="messages"></div>

          <!-- Form messaggio -->
          <form id="chat-form" class="chat-form">
            <div id="block-banner" class="hidden" style="color:#ff6b9b;font-weight:700;">
              Non puoi inviare messaggi all'utente
            </div>

            <div class="chat-input">
              <input type="text" id="chat-input" placeholder="Message @username" autocomplete="off">
              <button type="submit" class="btn">Invia</button>
            </div>
          </form>

        </div>

        <!-- PROFILE CARD (colonna destra) -->
        <aside class="profile-card">

          <div class="profile-avatar" id="profile-avatar">N</div>

          <div>
            <div class="friend-name" id="profile-name"></div>
            <div class="friend-status" id="profile-status"></div>
          </div>

          <div class="tag" id="profile-tag">Profilo</div>
          <div class="friend-status" id="profile-meta"></div>

        </aside>

      </div>

    </section>
    <!-- ========================= -->
    <!--      ADD FRIEND MODAL    -->
    <!-- ========================= -->

    <div id="modal" class="overlay hidden" role="dialog" aria-modal="true">
      <div class="modal">

        <h3>Aggiungi un amico</h3>
        <p>Inserisci il nickname del tuo amico per inviare la richiesta.</p>

        <input type="text" id="friend-name" class="input" placeholder="Nickname">
        <div id="modal-status" class="status"></div>

        <div class="modal-actions">
          <button class="btn ghost" id="close-modal">Annulla</button>
          <button class="btn" id="confirm-add">Invia richiesta</button>
        </div>

      </div>
    </div>

    <!-- ========================= -->
    <!--     PROFILE OVERLAY       -->
    <!-- ========================= -->

    <div id="profile-overlay" class="profile-overlay hidden" role="dialog" aria-modal="true">

      <div class="profile-modal">

        <!-- Close button -->
        <button id="close-profile" class="close-profile">Ã—</button>

        <!-- Left menu -->
        <div class="profile-nav">

          <h4>Personalizza</h4>

          <div class="logout-card">
            <div class="label">Log out</div>
            <button type="button" id="logout-btn">Esci</button>
          </div>

        </div>

        <!-- Right area -->
        <div class="profile-body">

          <!-- SECTION: PROFILE -->
          <div class="section">

            <h5>User Profile</h5>

            <!-- Avatar -->
            <div class="row" style="margin-bottom: 12px;">
              <label class="avatar-upload">
                <div class="profile-avatar" id="account-avatar">N</div>
                <input type="file" id="avatar-input" accept="image/*">
              </label>

              <div>
                <div class="friend-name" id="account-name">Nova User</div>
                <div class="friend-status" id="account-status"></div>
                <div class="handle" id="account-handle">@utente</div>
              </div>
            </div>

            <!-- ABOUT -->
            <div class="field editable" data-edit="about">
              <strong>About me:</strong>
              <span id="account-about">Sempre online su NovaChat.</span>

              <button class="edit-hint">âœŽ</button>

              <div class="inline-editor hidden" data-editor="about">
                <input id="edit-about" type="text">
                <button class="save" data-save="about">Salva</button>
                <button class="cancel" data-cancel="about">Annulla</button>
              </div>
            </div>

            <!-- DISPLAY NAME -->
            <div class="field editable" data-edit="display">
              <strong>Display name:</strong>
              <span id="account-display"></span>

              <button class="edit-hint">âœŽ</button>

              <div class="inline-editor hidden" data-editor="display">
                <input id="edit-display" type="text">
                <button class="save" data-save="display">Salva</button>
                <button class="cancel" data-cancel="display">Annulla</button>
              </div>
            </div>

            <!-- USERNAME -->
            <div class="field editable" data-edit="username">
              <strong>Username:</strong>
              <span id="account-username"></span>

              <button class="edit-hint">âœŽ</button>

              <div class="inline-editor hidden" data-editor="username">
                <input id="edit-username" type="text">
                <button class="save" data-save="username">Salva</button>
                <button class="cancel" data-cancel="username">Annulla</button>
              </div>
            </div>

          </div>

          <!-- SECTION: INFO -->
          <div class="section">

            <h5>Info</h5>

            <!-- STATUS -->
            <div class="field editable" data-edit="state">
              <strong>Stato:</strong>
              <span id="account-state"></span>

              <button class="edit-hint">âœŽ</button>

              <div class="inline-editor hidden" data-editor="state">
                <select id="edit-state">
                  <option value="online">Online</option>
                  <option value="offline">Offline</option>
                </select>

                <button class="save" data-save="state">Aggiorna</button>
                <button class="cancel" data-cancel="state">Annulla</button>
              </div>
            </div>

            <!-- MEMBER SINCE -->
            <div class="field">
              <strong>Member Since:</strong>
              <span id="account-member"></span>
            </div>

          </div>

        </div>
      </div>
    </div>

    <!-- Toast notifications -->
    <div class="toast-stack" id="toast-stack"></div>
  <script type="module">
    /* ------------------------------------------------------------------
       1. Firebase init
    ------------------------------------------------------------------ */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import {
      getFirestore,
      doc,
      getDoc,
      setDoc,
      updateDoc
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAxkmhYkXr7o3cuJL8Hr1f-4RjyTw-E7gg",
      authDomain: "novachat-c6eec.firebaseapp.com",
      projectId: "novachat-c6eec",
      storageBucket: "novachat-c6eec.firebasestorage.app",
      messagingSenderId: "953037847978",
      appId: "1:953037847978:web:779169b73da088b4bb7fd3"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    /* ------------------------------------------------------------------
       2. DataStore Firestore
    ------------------------------------------------------------------ */

    const USERS_COLLECTION = "users";
    const SESSION_KEY = "novachat-session";

    const normalizeName = (value = "") =>
      value.trim().replace(/^@+/, "").toLowerCase();

    const userRef = (username) =>
      doc(db, USERS_COLLECTION, normalizeName(username));

    async function safeGetUser(username) {
      const snap = await getDoc(userRef(username));
      if (!snap.exists()) return null;
      const data = snap.data() || {};
      return {
        password: data.password || "",
        displayName: data.displayName || normalizeName(username),
        about: data.about || "Sempre online su NovaChat.",
        avatar: data.avatar || "",
        status: data.status || "offline",
        createdAt: data.createdAt || new Date().toISOString(),
        friends: Array.isArray(data.friends) ? data.friends : [],
        pending: Array.isArray(data.pending) ? data.pending : [],
        messages: data.messages || {}
      };
    }

    const DataStore = {
      async exists(username) {
        const snap = await getDoc(userRef(username));
        return snap.exists();
      },

      async register(username, password) {
        const clean = normalizeName(username);
        if (!clean) {
          return { ok: false, message: "Username non valido." };
        }

        if (await this.exists(clean)) {
          return {
            ok: false,
            message: "Questo username Ã¨ giÃ  in uso. Scegline un altro."
          };
        }

        const userDoc = {
          password,
          displayName: clean,
          about: "Sempre online su NovaChat.",
          avatar: "",
          status: "offline",
          createdAt: new Date().toISOString(),
          friends: [],
          pending: [],
          messages: {}
        };

        await setDoc(userRef(clean), userDoc);
        return { ok: true, user: clean };
      },

      async login(username, password) {
        const clean = normalizeName(username);
        const snap = await getDoc(userRef(clean));
        if (!snap.exists()) {
          return { ok: false, message: "Credenziali non valide. Ritenta." };
        }

        const data = snap.data();
        if (data.password !== password) {
          return { ok: false, message: "Credenziali non valide. Ritenta." };
        }

        return { ok: true, user: clean };
      },

      async getUser(username) {
        return await safeGetUser(username);
      },

      async setStatus(username, status) {
        const clean = normalizeName(username);
        const current = await safeGetUser(clean);
        if (!current) return;
        await updateDoc(userRef(clean), { status });
      },

      async updateProfile(username, payload) {
        const clean = normalizeName(username);
        await updateDoc(userRef(clean), payload);
      },

      async addPending(sender, friendName) {
        const from = normalizeName(sender);
        const target = normalizeName(friendName);

        if (!target) {
          return { ok: false, message: "Nickname non valido." };
        }
        if (from === target) {
          return { ok: false, message: "Non puoi aggiungere te stesso." };
        }

        const targetUser = await safeGetUser(target);
        if (!targetUser) {
          return { ok: false, message: "Utente non trovato." };
        }

        const alreadyFriend = targetUser.friends.some(
          (f) => normalizeName(f.name) === from
        );
        if (alreadyFriend) {
          return { ok: false, message: "Questo utente Ã¨ giÃ  tra i tuoi amici." };
        }

        const alreadyPending = targetUser.pending.some(
          (p) => normalizeName(p.name) === from
        );
        if (alreadyPending) {
          return { ok: false, message: "Richiesta giÃ  inviata." };
        }

        const nextPending = [...targetUser.pending, { name: from }];
        await updateDoc(userRef(target), { pending: nextPending });
        return { ok: true };
      },

      async accept(username, friendName) {
        const owner = normalizeName(username);
        const other = normalizeName(friendName);

        const ownerUser = await safeGetUser(owner);
        const otherUser = await safeGetUser(other);
        if (!ownerUser || !otherUser) return;

        // Rimuovi dalla pending
        const nextPending = ownerUser.pending.filter(
          (p) => normalizeName(p.name) !== other
        );

        // Aggiungi friend per owner
        const hasAlready = ownerUser.friends.some(
          (f) => normalizeName(f.name) === other
        );
        const ownerFriends = hasAlready
          ? ownerUser.friends
          : [...ownerUser.friends, { name: other, blocked: false, pinned: false }];

        await updateDoc(userRef(owner), {
          pending: nextPending,
          friends: ownerFriends
        });

        // Aggiungi friend anche all'altro
        const otherHasOwner = otherUser.friends.some(
          (f) => normalizeName(f.name) === owner
        );
        const otherFriends = otherHasOwner
          ? otherUser.friends
          : [...otherUser.friends, { name: owner, blocked: false, pinned: false }];

        await updateDoc(userRef(other), {
          friends: otherFriends
        });
      },

      async decline(username, friendName) {
        const owner = normalizeName(username);
        const other = normalizeName(friendName);

        const ownerUser = await safeGetUser(owner);
        if (!ownerUser) return;

        const nextPending = ownerUser.pending.filter(
          (p) => normalizeName(p.name) !== other
        );
        await updateDoc(userRef(owner), { pending: nextPending });
      },

      async toggleBlock(username, friendName) {
        const owner = normalizeName(username);
        const other = normalizeName(friendName);

        const ownerUser = await safeGetUser(owner);
        if (!ownerUser) return;

        const friends = ownerUser.friends.map((f) => {
          if (normalizeName(f.name) !== other) return f;
          return { ...f, blocked: !f.blocked };
        });

        await updateDoc(userRef(owner), { friends });
      },

      async togglePin(username, friendName) {
        const owner = normalizeName(username);
        const other = normalizeName(friendName);

        const ownerUser = await safeGetUser(owner);
        if (!ownerUser) return;

        const friends = ownerUser.friends.map((f) => {
          if (normalizeName(f.name) !== other) return f;
          return { ...f, pinned: !f.pinned };
        });

        await updateDoc(userRef(owner), { friends });
      },

      async removeFriend(username, friendName) {
        const owner = normalizeName(username);
        const other = normalizeName(friendName);

        const ownerUser = await safeGetUser(owner);
        const otherUser = await safeGetUser(other);

        if (ownerUser) {
          const ownerFriends = ownerUser.friends.filter(
            (f) => normalizeName(f.name) !== other
          );
          await updateDoc(userRef(owner), { friends: ownerFriends });
        }

        if (otherUser) {
          const otherFriends = otherUser.friends.filter(
            (f) => normalizeName(f.name) !== owner
          );
          await updateDoc(userRef(other), { friends: otherFriends });
        }
      },

      async clearChat(username, friendName) {
        const owner = normalizeName(username);
        const other = normalizeName(friendName);

        const ownerUser = await safeGetUser(owner);
        if (ownerUser) {
          const msgs = ownerUser.messages || {};
          msgs[other] = [];
          await updateDoc(userRef(owner), { messages: msgs });
        }

        const otherUser = await safeGetUser(other);
        if (otherUser) {
          const msgs2 = otherUser.messages || {};
          msgs2[owner] = [];
          await updateDoc(userRef(other), { messages: msgs2 });
        }
      },

      async saveMessage(sender, friendName, text) {
        const from = normalizeName(sender);
        const to = normalizeName(friendName);

        const senderUser = await safeGetUser(from);
        if (!senderUser) return { delivered: false };

        const time = new Date().toLocaleTimeString([], {
          hour: "2-digit",
          minute: "2-digit"
        });

        // Aggiorna mittente
        const senderMessages = senderUser.messages || {};
        const arrFrom = senderMessages[to] || [];
        arrFrom.push({ from, text, time });
        senderMessages[to] = arrFrom;
        await updateDoc(userRef(from), { messages: senderMessages });

        // Aggiorna destinatario, se esiste
        const targetUser = await safeGetUser(to);
        if (targetUser) {
          const targetMessages = targetUser.messages || {};
          const arrTo = targetMessages[from] || [];
          arrTo.push({ from, text, time });
          targetMessages[from] = arrTo;
          await updateDoc(userRef(to), { messages: targetMessages });
        }

        return { delivered: Boolean(targetUser) };
      }
    };

    /* ------------------------------------------------------------------
       3. Riferimenti DOM
    ------------------------------------------------------------------ */

    const splash = document.querySelector(".splash");
    const authView = document.getElementById("auth-view");
    const mainView = document.getElementById("main-view");
    const chatView = document.getElementById("chat-view");
    const appShell = document.getElementById("app");

    const form = document.getElementById("auth-form");
    const statusEl = document.getElementById("status");
    const switchBtn = document.getElementById("switch-btn");
    const switchCopy = document.getElementById("switch-copy");
    const submitBtn = document.getElementById("submit-btn");
    const title = document.getElementById("form-title");
    const subtitle = document.getElementById("form-subtitle");
    const usernameField = document.getElementById("username");
    const passwordField = document.getElementById("password");
    const stayLoggedToggle = document.getElementById("stay-logged");

    const friendList = document.getElementById("friend-list");
    const filters = document.getElementById("filters");
    const searchInput = document.getElementById("search");
    const onlineCount = document.getElementById("online-count");
    const offlineCount = document.getElementById("offline-count");
    const addFriendBtn = document.getElementById("add-friend");
    const sideAddBtn = document.getElementById("side-add");

    const sideAvatar = document.getElementById("side-avatar");
    const sideName = document.getElementById("side-name");
    const sideHandle = document.getElementById("side-handle");
    const sideStatus = document.getElementById("side-status");
    const memberSince = document.getElementById("member-since");
    const openProfile = document.getElementById("open-profile");

    const modal = document.getElementById("modal");
    const modalStatus = document.getElementById("modal-status");
    const friendInput = document.getElementById("friend-name");
    const closeModal = document.getElementById("close-modal");
    const confirmAdd = document.getElementById("confirm-add");

    const profileOverlay = document.getElementById("profile-overlay");
    const closeProfile = document.getElementById("close-profile");
    const logoutBtn = document.getElementById("logout-btn");

    const accountAvatar = document.getElementById("account-avatar");
    const accountName = document.getElementById("account-name");
    const accountStatus = document.getElementById("account-status");
    const accountHandle = document.getElementById("account-handle");
    const accountAbout = document.getElementById("account-about");
    const accountDisplay = document.getElementById("account-display");
    const accountUsername = document.getElementById("account-username");
    const accountState = document.getElementById("account-state");
    const accountMember = document.getElementById("account-member");
    const avatarInput = document.getElementById("avatar-input");
    const editAbout = document.getElementById("edit-about");
    const editDisplay = document.getElementById("edit-display");
    const editUsername = document.getElementById("edit-username");
    const editState = document.getElementById("edit-state");

    const chatName = document.getElementById("chat-name");
    const chatStatus = document.getElementById("chat-status");
    const messagesEl = document.getElementById("messages");
    const chatForm = document.getElementById("chat-form");
    const chatInput = document.getElementById("chat-input");
    const blockBanner = document.getElementById("block-banner");
    const profileAvatar = document.getElementById("profile-avatar");
    const profileName = document.getElementById("profile-name");
    const profileStatus = document.getElementById("profile-status");
    const profileMeta = document.getElementById("profile-meta");
    const backToMain = document.getElementById("back-to-main");

    const toastStack = document.getElementById("toast-stack");

    /* ------------------------------------------------------------------
       4. Stato UI
    ------------------------------------------------------------------ */

    let mode = "login"; // 'login' | 'signup'
    let currentUserName = null;
    let currentUser = null; // oggetto utente da Firestore
    let filter = "all"; // 'all' | 'online' | 'pending' | 'blocked'
    let activeFriend = null; // string (username)

    /* ------------------------------------------------------------------
       5. UtilitÃ  UI
    ------------------------------------------------------------------ */

    function triggerSplash() {
      splash?.classList.remove("burst");
      // forza reflow
      void splash?.offsetWidth;
      splash?.classList.add("burst");
    }

    function formatDate(value) {
      const date = new Date(value);
      if (Number.isNaN(date.getTime())) return "Nuovo membro";
      return date.toLocaleDateString("it-IT", { month: "short", year: "numeric" });
    }

    function persistSession(user, stay) {
      if (stay && user) {
        localStorage.setItem(
          SESSION_KEY,
          JSON.stringify({ user, stay: true })
        );
      } else {
        localStorage.removeItem(SESSION_KEY);
      }
    }

    function loadSession() {
      const raw = localStorage.getItem(SESSION_KEY);
      try {
        return raw ? JSON.parse(raw) : null;
      } catch {
        return null;
      }
    }

    function applyAvatarElement(el, user, fallbackName = "N") {
      if (!el) return;
      const avatar = user?.avatar;
      el.style.backgroundImage = avatar ? `url(${avatar})` : "none";
      el.style.backgroundSize = "cover";
      el.style.backgroundPosition = "center";
      el.textContent = avatar
        ? ""
        : (user?.displayName?.charAt(0)?.toUpperCase() ||
           fallbackName.charAt(0).toUpperCase());
    }

    function showViewAuth() {
      authView.classList.remove("hidden");
      mainView.classList.add("hidden");
      chatView.classList.add("hidden");
    }

    function showViewMain() {
      authView.classList.add("hidden");
      chatView.classList.add("hidden");
      mainView.classList.remove("hidden");
    }

    function showViewChat() {
      authView.classList.add("hidden");
      mainView.classList.add("hidden");
      chatView.classList.remove("hidden");
    }

    function setMode(newMode) {
      mode = newMode;
      const isSignup = mode === "signup";

      title.textContent = "NovaChat";
      subtitle.textContent = isSignup
        ? "Crea il tuo account per entrare nella chat. Nessuna email, solo username e password."
        : "Accedi con il tuo username e la tua password.";

      submitBtn.textContent = isSignup ? "Crea account" : "Accedi";
      switchCopy.textContent = isSignup
        ? "Hai giÃ  un account?"
        : "Non hai ancora un account?";
      switchBtn.textContent = isSignup ? "Accedi" : "Registrati";

      statusEl.textContent = "";
      statusEl.className = "status";

      triggerSplash();
    }

    function showStatus(ok, msg) {
      statusEl.className = "status " + (ok ? "success" : "error");
      statusEl.textContent = msg;
    }

    function makeEmpty(text) {
      const div = document.createElement("div");
      div.className = "empty";
      div.textContent = text;
      return div;
    }

    function showToast(title, text) {
      if (!toastStack) return;
      const toast = document.createElement("div");
      toast.className = "toast";
      toast.innerHTML = `
        <div class="meta">
          <strong>${title}</strong>
          <span>Avviso</span>
        </div>
        <div>${text}</div>
      `;
      toastStack.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    /* ------------------------------------------------------------------
       6. Rendering UI
    ------------------------------------------------------------------ */

    async function refreshCurrentUser() {
      if (!currentUserName) return;
      currentUser = await DataStore.getUser(currentUserName);
    }

    async function renderUserSummary() {
      if (!currentUser) return;
      applyAvatarElement(sideAvatar, currentUser, currentUserName);
      sideName.textContent = currentUser.displayName || currentUserName;
      sideHandle.textContent = "@" + currentUserName;
      sideStatus.innerHTML = `
        <span class="dot ${currentUser.status === "online" ? "online" : "offline"}"></span>
        ${currentUser.status === "online" ? "Online" : "Offline"}
      `;
      memberSince.textContent = "Dal " + formatDate(currentUser.createdAt);
    }

    async function renderAccountPanel() {
      if (!currentUser) return;
      applyAvatarElement(accountAvatar, currentUser, currentUserName);
      accountName.textContent = currentUser.displayName || currentUserName;
      accountHandle.textContent = "@" + currentUserName;
      accountStatus.innerHTML = `
        <span class="dot ${currentUser.status === "online" ? "online" : "offline"}"></span>
        ${currentUser.status === "online" ? "Online" : "Offline"}
      `;
      accountDisplay.textContent = currentUser.displayName || currentUserName;
      accountUsername.textContent = currentUserName;
      accountState.textContent = currentUser.status === "online" ? "Online" : "Offline";
      accountMember.textContent = formatDate(currentUser.createdAt);
      accountAbout.textContent = currentUser.about || "Sempre online su NovaChat.";

      editAbout.value = currentUser.about || "";
      editDisplay.value = currentUser.displayName || currentUserName;
      editUsername.value = currentUserName;
      editState.value = currentUser.status || "offline";
    }

    async function renderFriends() {
      if (!currentUser) return;
      friendList.innerHTML = "";

      const term = (searchInput.value || "").trim().toLowerCase();

      // Pending view
      if (filter === "pending") {
        const pending = currentUser.pending || [];
        if (!pending.length) {
          friendList.appendChild(
            makeEmpty('Nessuna richiesta in arrivo. Invia un invito da "Add Friend".')
          );
          onlineCount.textContent = "0";
          offlineCount.textContent = String(currentUser.friends.length);
          return;
        }

        pending.forEach((p) => {
          const card = document.createElement("div");
          card.className = "friend-card";
          const initial = (p.name || "?").charAt(0).toUpperCase();
          card.innerHTML = `
            <div class="avatar">${initial}</div>
            <div class="friend-meta">
              <div class="friend-name">${p.name}</div>
              <div class="friend-status">
                <span class="dot online"></span> Richiesta in arrivo
              </div>
            </div>
            <div style="display:flex;gap:8px;">
              <button class="action-btn" data-accept="${p.name}">Accetta</button>
              <button class="action-btn" data-decline="${p.name}">Rifiuta</button>
            </div>
          `;
          friendList.appendChild(card);
        });

        onlineCount.textContent = String(currentUser.friends.length);
        offlineCount.textContent = "0";
        return;
      }

      // Friends list
      const friends = (currentUser.friends || [])
        .filter((f) => {
          if (!f) return false;
          const n = (f.name || "").toLowerCase();
          if (term && !n.includes(term)) return false;
          if (filter === "blocked") return !!f.blocked;
          if (filter === "online") {
            // Non abbiamo presence realtime: li consideriamo tutti "offline"
            return !f.blocked; // volendo: solo non bloccati
          }
          // filter === "all"
          return !f.blocked;
        })
        .sort((a, b) => Number(b.pinned) - Number(a.pinned));

      if (!friends.length) {
        friendList.appendChild(
          makeEmpty(
            filter === "blocked"
              ? "Non hai utenti bloccati."
              : 'Non hai ancora amici qui. Usa "Add Friend" per iniziare.'
          )
        );
        onlineCount.textContent = "0";
        offlineCount.textContent = "0";
        return;
      }

      let online = 0;
      let offline = 0;

      friends.forEach((f) => {
        const card = document.createElement("div");
        card.className = "friend-card";
        card.dataset.friend = f.name;

        const initial = f.name.charAt(0).toUpperCase();
        // senza presence reale, li segniamo Offline di default
        const isBlocked = !!f.blocked;
        const statusClass = isBlocked ? "blocked" : "offline";
        const statusLabel = isBlocked ? "Bloccato" : "Offline";

        if (!isBlocked) offline++;

        card.innerHTML = `
          <div class="avatar">${initial}</div>
          <div class="friend-meta">
            <div class="friend-name">${f.name}${f.pinned ? " ðŸ“Œ" : ""}</div>
            <div class="friend-status">
              <span class="dot ${statusClass}"></span>${statusLabel}
            </div>
          </div>
          <div class="friend-actions">
            <button class="action-btn" type="button">â‹¯</button>
            <div class="menu">
              <button data-action="pin" data-friend="${f.name}">
                ${f.pinned ? "Rimuovi fissato" : "Fissa in alto"}
              </button>
              <button data-action="block" data-friend="${f.name}">
                ${f.blocked ? "Sblocca" : "Blocca"}
              </button>
              <button data-action="remove" data-friend="${f.name}">
                Rimuovi amicizia
              </button>
              <button data-action="clear" data-friend="${f.name}">
                Cancella chat
              </button>
            </div>
          </div>
        `;

        friendList.appendChild(card);
      });

      onlineCount.textContent = String(online);
      offlineCount.textContent = String(offline);
    }

    async function renderMessagesForFriend(friendName) {
      messagesEl.innerHTML = "";
      if (!currentUser) return;

      const msgsMap = currentUser.messages || {};
      const list = msgsMap[normalizeName(friendName)] || [];

      if (!list.length) {
        messagesEl.appendChild(
          makeEmpty("La chat Ã¨ vuota. Invia un messaggio per iniziare.")
        );
        return;
      }

      list.forEach((m) => {
        const bubble = document.createElement("div");
        bubble.className = "bubble " + (normalizeName(m.from) === normalizeName(currentUserName) ? "me" : "them");
        bubble.innerHTML = `
          <div>${m.text}</div>
          <div class="timestamp">${m.time || ""}</div>
        `;
        messagesEl.appendChild(bubble);
      });

      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    async function showChat(friendName) {
      activeFriend = friendName;
      await refreshCurrentUser();

      const friend = (currentUser.friends || []).find(
        (f) => normalizeName(f.name) === normalizeName(friendName)
      );
      if (!friend) {
        showToast("Chat", "Utente non Ã¨ piÃ¹ nella tua lista amici.");
        await renderFriends();
        showViewMain();
        return;
      }

      showViewChat();

      // intestazione
      chatName.textContent = friend.name;
      chatStatus.innerHTML = `
        <span class="dot ${friend.blocked ? "blocked" : "offline"}"></span>
        ${friend.blocked ? "Blocked" : "Offline"}
      `;

      // pannello profilo
      const fUser = await DataStore.getUser(friend.name);
      applyAvatarElement(profileAvatar, fUser, friend.name);
      profileName.textContent = fUser?.displayName || friend.name;
      profileStatus.innerHTML = `
        <span class="dot ${friend.blocked ? "blocked" : "offline"}"></span>
        ${friend.blocked ? "Bloccato" : "Offline"}
      `;
      profileMeta.textContent = friend.pinned ? "Fissato in alto" : "Contatto standard";

      chatInput.placeholder = "Message @" + friend.name;
      const blocked = !!friend.blocked;
      blockBanner.classList.toggle("hidden", !blocked);
      chatInput.disabled = blocked;

      await refreshCurrentUser();
      await renderMessagesForFriend(friend.name);
    }

    /* ------------------------------------------------------------------
       7. Eventi UI
    ------------------------------------------------------------------ */

    // Auth submit
    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const username = (usernameField.value || "").trim();
      const password = (passwordField.value || "").trim();
      if (!username || !password) return;

      const action = mode === "signup" ? DataStore.register.bind(DataStore) : DataStore.login.bind(DataStore);
      const result = await action(username, password);

      showStatus(result.ok, result.ok
        ? (mode === "signup"
          ? "Account creato con successo. Benvenuto su NovaChat!"
          : "Login effettuato con successo.")
        : result.message
      );

      if (result.ok) {
        currentUserName = result.user || normalizeName(username);
        passwordField.value = "";
        persistSession(currentUserName, stayLoggedToggle.checked);
        triggerSplash();
        await afterLogin();
      }
    });

    async function afterLogin() {
      await DataStore.setStatus(currentUserName, "online");
      await refreshCurrentUser();
      await renderUserSummary();
      await renderAccountPanel();
      await renderFriends();
      showViewMain();
    }

    // Switch login/signup
    switchBtn.addEventListener("click", () => {
      setMode(mode === "signup" ? "login" : "signup");
    });

    // Splash anim end
    splash?.addEventListener("animationend", (ev) => {
      if (ev.animationName === "splashBurst") {
        splash.classList.remove("burst");
      }
    });

    // Filters
    filters.addEventListener("click", (e) => {
      const btn = e.target.closest("button[data-filter]");
      if (!btn) return;
      filter = btn.dataset.filter;
      [...filters.querySelectorAll("button")].forEach((b) =>
        b.classList.toggle("active", b === btn)
      );
      renderFriends();
    });

    // Search
    searchInput.addEventListener("input", () => {
      renderFriends();
    });

    // Friend list click
    friendList.addEventListener("click", async (e) => {
      const accept = e.target.dataset.accept;
      const decline = e.target.dataset.decline;

      if (accept) {
        await DataStore.accept(currentUserName, accept);
        await refreshCurrentUser();
        await renderFriends();
        showToast("Richiesta", `Hai accettato ${accept}.`);
        return;
      }

      if (decline) {
        await DataStore.decline(currentUserName, decline);
        await refreshCurrentUser();
        await renderFriends();
        showToast("Richiesta", `Hai rifiutato ${decline}.`);
        return;
      }

      const actionBtn = e.target.closest(".action-btn");
      if (actionBtn && actionBtn.nextElementSibling?.classList.contains("menu")) {
        const menu = actionBtn.nextElementSibling;
        const open = menu.style.display === "flex";
        document
          .querySelectorAll(".friend-actions .menu")
          .forEach((m) => (m.style.display = "none"));
        menu.style.display = open ? "none" : "flex";
        e.stopPropagation();
        return;
      }

      const action = e.target.dataset.action;
      const friendName = e.target.dataset.friend;
      if (action && friendName) {
        if (action === "block") {
          await DataStore.toggleBlock(currentUserName, friendName);
        } else if (action === "pin") {
          await DataStore.togglePin(currentUserName, friendName);
        } else if (action === "remove") {
          await DataStore.removeFriend(currentUserName, friendName);
          if (activeFriend && normalizeName(activeFriend) === normalizeName(friendName)) {
            activeFriend = null;
            showViewMain();
          }
        } else if (action === "clear") {
          await DataStore.clearChat(currentUserName, friendName);
        }
        await refreshCurrentUser();
        await renderFriends();
        return;
      }

      const card = e.target.closest(".friend-card");
      if (!card || filter === "pending") return;
      const name = card.dataset.friend;
      if (!name) return;

      await showChat(name);
    });

    friendList.addEventListener("mouseleave", () => {
      document
        .querySelectorAll(".friend-actions .menu")
        .forEach((m) => (m.style.display = "none"));
    });

    // Add friend (main & side)
    function openAddFriendModal() {
      modal.classList.remove("hidden");
      appShell.classList.add("blurred");
      modalStatus.textContent = "";
      modalStatus.className = "status";
      friendInput.value = "";
      friendInput.focus();
    }

    addFriendBtn.addEventListener("click", openAddFriendModal);
    sideAddBtn.addEventListener("click", openAddFriendModal);

    closeModal.addEventListener("click", () => {
      modal.classList.add("hidden");
      appShell.classList.remove("blurred");
    });

    modal.addEventListener("click", (e) => {
      if (e.target === modal) {
        modal.classList.add("hidden");
        appShell.classList.remove("blurred");
      }
    });

    confirmAdd.addEventListener("click", async () => {
      const name = normalizeName(friendInput.value || "");
      if (!name) return;
      const result = await DataStore.addPending(currentUserName, name);
      modalStatus.className = "status " + (result.ok ? "success" : "error");
      modalStatus.textContent = result.ok
        ? `Richiesta inviata a ${name}.`
        : result.message;
      if (result.ok) {
        setTimeout(() => {
          modal.classList.add("hidden");
          appShell.classList.remove("blurred");
        }, 700);
      }
    });

    // Profile overlay
    openProfile.addEventListener("click", async () => {
      await refreshCurrentUser();
      await renderAccountPanel();
      profileOverlay.classList.remove("hidden");
      appShell.classList.add("blurred");
    });

    closeProfile.addEventListener("click", () => {
      profileOverlay.classList.add("hidden");
      appShell.classList.remove("blurred");
    });

    profileOverlay.addEventListener("click", (e) => {
      if (e.target === profileOverlay) {
        profileOverlay.classList.add("hidden");
        appShell.classList.remove("blurred");
      }
    });

    // Logout
    logoutBtn.addEventListener("click", async () => {
      if (currentUserName) {
        await DataStore.setStatus(currentUserName, "offline");
      }
      currentUserName = null;
      currentUser = null;
      persistSession("", false);
      showViewAuth();
      usernameField.value = "";
      passwordField.value = "";
      stayLoggedToggle.checked = false;
      setMode("login");
      appShell.classList.remove("blurred");
      profileOverlay.classList.add("hidden");
      modal.classList.add("hidden");
    });

    // Avatar upload
    avatarInput.addEventListener("change", (e) => {
      const file = e.target.files?.[0];
      if (!file || !currentUserName) return;
      const reader = new FileReader();
      reader.onload = async () => {
        await DataStore.updateProfile(currentUserName, { avatar: reader.result });
        await refreshCurrentUser();
        await renderUserSummary();
        await renderAccountPanel();
      };
      reader.readAsDataURL(file);
    });

    // Inline editor (about, display, username, state)
    function toggleEditor(field, open) {
      const editor = document.querySelector(
        `.inline-editor[data-editor="${field}"]`
      );
      if (!editor) return;
      editor.classList.toggle("hidden", !open);
      if (open) {
        const input = editor.querySelector("input,select");
        input && input.focus();
      }
    }

    document.querySelectorAll(".edit-hint").forEach((btn) => {
      const field = btn.closest(".editable")?.dataset.edit;
      if (!field) return;
      btn.addEventListener("click", () => toggleEditor(field, true));
    });

    document.querySelectorAll(".cancel").forEach((btn) => {
      const field = btn.dataset.cancel;
      btn.addEventListener("click", () => toggleEditor(field, false));
    });

    document.querySelectorAll(".save").forEach((btn) => {
      const field = btn.dataset.save;
      btn.addEventListener("click", async () => {
        if (!currentUserName) return;
        if (field === "about") {
          await DataStore.updateProfile(currentUserName, {
            about: editAbout.value.trim()
          });
        } else if (field === "display") {
          const value = editDisplay.value.trim() || currentUserName;
          await DataStore.updateProfile(currentUserName, {
            displayName: value
          });
        } else if (field === "username") {
          alert("Cambio username non ancora supportato in questa versione.");
        } else if (field === "state") {
          await DataStore.setStatus(currentUserName, editState.value);
        }
        await refreshCurrentUser();
        await renderUserSummary();
        await renderAccountPanel();
        await renderFriends();
        toggleEditor(field, false);
      });
    });

    // Chat form submit
    chatForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!activeFriend) return;
      if (chatInput.disabled) return;
      const text = (chatInput.value || "").trim();
      if (!text) return;

      await DataStore.saveMessage(currentUserName, activeFriend, text);
      chatInput.value = "";
      await refreshCurrentUser();
      await renderMessagesForFriend(activeFriend);
    });

    backToMain.addEventListener("click", async () => {
      activeFriend = null;
      await refreshCurrentUser();
      await renderFriends();
      showViewMain();
    });

    /* ------------------------------------------------------------------
       8. Bootstrap
    ------------------------------------------------------------------ */

    async function restoreSession() {
      const saved = loadSession();
      if (saved?.user && saved.stay) {
        const exists = await DataStore.exists(saved.user);
        if (exists) {
          currentUserName = saved.user;
          await afterLogin();
          return;
        }
      }
      setMode(mode);
      showViewAuth();
    }

    window.addEventListener("beforeunload", async () => {
      if (currentUserName) {
        await DataStore.setStatus(currentUserName, "offline");
      }
    });

    // Avvio
    restoreSession();
  </script>
</body>
</html>

