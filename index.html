<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NovaChat | Accesso</title>
  <style>
    :root {
      --bg: #0d0f17;
      --panel: rgba(20, 23, 35, 0.72);
      --panel-strong: rgba(29, 32, 47, 0.85);
      --text: #f5f6ff;
      --muted: #c3c7d8;
      --accent: #9d6bff;
      --accent-2: #5cf0ff;
      --danger: #ff6b9b;
      --success: #8df7c5;
      --border: rgba(255, 255, 255, 0.06);
      --glow: 0 16px 40px rgba(111, 111, 255, 0.35);
      --card-radius: 20px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif;
    }

    body {
      min-height: 100vh;
      background:
        radial-gradient(circle at 20% 20%, rgba(157, 107, 255, 0.24), transparent 40%),
        radial-gradient(circle at 80% 15%, rgba(92, 240, 255, 0.2), transparent 32%),
        radial-gradient(circle at 50% 80%, rgba(255, 107, 155, 0.18), transparent 30%),
        var(--bg);
      color: var(--text);
      display: grid;
      place-items: center;
      padding: 32px 16px;
      overflow: hidden;
      position: relative;
      isolation: isolate;
    }

    .grain {
      position: fixed;
      inset: 0;
      opacity: 0.26;
      pointer-events: none;
      background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="160" height="160" viewBox="0 0 160 160"><filter id="n"><feTurbulence type="fractalNoise" baseFrequency="0.8" numOctaves="4" stitchTiles="stitch"/></filter><rect width="160" height="160" filter="url(%23n)" opacity="0.55"/></svg>');
      mix-blend-mode: soft-light;
      z-index: -1;
    }

    .orb {
      position: absolute;
      width: 320px;
      height: 320px;
      border-radius: 50%;
      filter: blur(70px);
      opacity: 0.55;
      z-index: -1;
      animation: float 12s ease-in-out infinite alternate;
    }

    .orb.one { background: rgba(157, 107, 255, 0.4); top: -60px; left: -40px; animation-delay: 0.5s; }
    .orb.two { background: rgba(92, 240, 255, 0.4); top: 40%; right: -120px; animation-duration: 14s; }
    .orb.three { background: rgba(255, 107, 155, 0.38); bottom: -80px; left: 18%; animation-duration: 16s; }

    @keyframes float {
      from { transform: translateY(-12px) scale(1); }
      to { transform: translateY(16px) scale(1.05); }
    }

    .app-shell {
      position: relative;
      width: min(1200px, 96vw);
      animation: intro 0.9s ease forwards;
      opacity: 0;
      transform: translateY(16px) scale(0.98);
    }

    @keyframes intro {
      0% { opacity: 0; transform: translateY(18px) scale(0.97); filter: blur(6px); }
      60% { opacity: 1; transform: translateY(-4px) scale(1.005); filter: blur(0); }
      100% { opacity: 1; transform: translateY(0) scale(1); }
    }

    .card-wrap { width: min(440px, 96vw); margin: 0 auto; }

    .splash {
      position: absolute;
      inset: -30%;
      background: radial-gradient(circle at 50% 40%, rgba(157, 107, 255, 0.35), transparent 45%),
                  radial-gradient(circle at 40% 60%, rgba(92, 240, 255, 0.3), transparent 48%),
                  radial-gradient(circle at 65% 70%, rgba(255, 107, 155, 0.32), transparent 48%);
      filter: blur(50px) saturate(1.3);
      opacity: 0.55;
      z-index: 0;
      animation: splashDrift 9s ease-in-out infinite;
      transform-origin: 60% 40%;
      overflow: hidden;
    }

    .splash::after {
      content: '';
      position: absolute;
      inset: 18% 12%;
      border-radius: 50%;
      background: radial-gradient(circle at 50% 50%, rgba(255,255,255,0.16), transparent 60%);
      filter: blur(12px);
      opacity: 0.75;
      animation: splashPulse 3.2s ease-in-out infinite;
    }

    .splash.burst::after { animation: splashBurst 1.6s ease-out; }

    @keyframes splashDrift {
      0% { transform: scale(0.95) rotate(-2deg); opacity: 0.55; }
      50% { transform: scale(1.05) rotate(2deg); opacity: 0.7; }
      100% { transform: scale(0.98) rotate(-3deg); opacity: 0.6; }
    }

    @keyframes splashPulse {
      0% { transform: scale(0.9); opacity: 0.4; }
      50% { transform: scale(1.05); opacity: 0.75; }
      100% { transform: scale(0.96); opacity: 0.45; }
    }

    @keyframes splashBurst {
      0% { transform: scale(0.8); opacity: 0.2; }
      50% { transform: scale(1.2); opacity: 0.65; }
      100% { transform: scale(1.05); opacity: 0.1; }
    }

    .card {
      position: relative;
      z-index: 1;
      background: linear-gradient(160deg, var(--panel), var(--panel-strong));
      border: 1px solid var(--border);
      box-shadow: var(--glow), 0 32px 90px rgba(0, 0, 0, 0.5);
      border-radius: var(--card-radius);
      padding: 32px 30px;
      display: flex;
      flex-direction: column;
      gap: 18px;
      backdrop-filter: blur(14px) saturate(1.3);
    }

    .logo {
      width: 72px;
      height: 72px;
      border-radius: 22px;
      background: linear-gradient(140deg, rgba(157, 107, 255, 0.18), rgba(92, 240, 255, 0.12)),
                  linear-gradient(160deg, #1f1b2f, #12111c);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.05), 0 14px 30px rgba(0,0,0,0.35);
      display: grid;
      place-items: center;
      margin-bottom: 8px;
      position: relative;
      overflow: hidden;
    }

    .logo::after {
      content: '';
      position: absolute;
      inset: -30%;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.08), transparent 50%);
      mix-blend-mode: screen;
      animation: logoSweep 6s ease-in-out infinite;
    }

    .logo img {
      width: 80%;
      height: 80%;
      object-fit: cover;
      border-radius: 18px;
      box-shadow: 0 0 0 1px rgba(255,255,255,0.05), 0 10px 22px rgba(0,0,0,0.35);
    }

    @keyframes logoSweep {
      0% { transform: translateX(-10%) translateY(-10%); opacity: 0.75; }
      50% { transform: translateX(6%) translateY(8%); opacity: 0.9; }
      100% { transform: translateX(-12%) translateY(-12%); opacity: 0.78; }
    }

    h1 { font-size: 26px; letter-spacing: -0.4px; }
    .subtitle { color: var(--muted); line-height: 1.5; }

    form { display: flex; flex-direction: column; gap: 12px; }

    label { font-weight: 700; font-size: 14px; color: #e9ebff; letter-spacing: 0.2px; }

    .input {
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px 14px;
      color: var(--text);
      font-weight: 600;
      transition: border 0.18s ease, box-shadow 0.18s ease, transform 0.12s ease;
    }

    .input:focus {
      outline: none;
      border-color: rgba(92, 240, 255, 0.5);
      box-shadow: 0 0 0 2px rgba(92, 240, 255, 0.16), 0 12px 32px rgba(92, 240, 255, 0.14);
      transform: translateY(-1px);
    }

    .btn {
      cursor: pointer;
      border: none;
      border-radius: 12px;
      padding: 14px 16px;
      color: #0d0f17;
      font-weight: 800;
      font-size: 15px;
      background: linear-gradient(120deg, var(--accent), #c06bff, var(--accent-2));
      background-size: 220% 220%;
      animation: shimmer 6s ease-in-out infinite;
      box-shadow: var(--glow);
      transition: transform 0.15s ease, box-shadow 0.2s ease;
    }

    .btn:hover { transform: translateY(-1px); box-shadow: 0 20px 50px rgba(157,107,255,0.35); }
    .btn:active { transform: translateY(1px); }

    @keyframes shimmer {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    .switcher { font-size: 14px; color: var(--muted); }
    .switcher button { background: none; border: none; color: var(--accent-2); font-weight: 700; cursor: pointer; }

    .status {
      min-height: 22px;
      font-size: 14px;
      font-weight: 700;
    }
    .status.error { color: var(--danger); }
    .status.success { color: var(--success); }
    .status.muted { color: var(--muted); }

    .helper { color: var(--muted); font-size: 13px; line-height: 1.5; text-align: center; }

    .hidden { display: none !important; }

    /* Main UI */
    .app-layout {
      display: grid;
      grid-template-columns: 220px 1fr 320px;
      gap: 18px;
      width: min(1200px, 96vw);
      min-height: 78vh;
      align-items: stretch;
    }

    .panel {
      background: linear-gradient(160deg, rgba(24, 28, 41, 0.75), rgba(16, 19, 29, 0.92));
      border: 1px solid var(--border);
      border-radius: var(--card-radius);
      padding: 18px;
      box-shadow: 0 18px 60px rgba(0, 0, 0, 0.35);
      backdrop-filter: blur(12px) saturate(1.1);
    }

    .main-panel {
      display: flex;
      flex-direction: column;
      min-height: 72vh;
    }

    .sidebar .brand {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 18px;
    }

    .sidebar .brand img { width: 36px; height: 36px; border-radius: 12px; }
    .sidebar .brand .name { font-weight: 800; letter-spacing: 0.2px; }

    .nav { list-style: none; display: flex; flex-direction: column; gap: 10px; }
    .nav button {
      width: 100%;
      text-align: left;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid transparent;
      background: rgba(255, 255, 255, 0.02);
      color: var(--text);
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: background 0.2s ease, transform 0.12s ease, border 0.2s ease;
    }

    .nav button.active { border-color: var(--border); background: rgba(255, 255, 255, 0.04); }
    .nav button:hover { transform: translateY(-1px); }

    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 12px;
    }

    .search {
      flex: 1;
      display: flex;
      gap: 8px;
    }

    .search input {
      flex: 1;
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px 12px;
      color: var(--text);
      font-weight: 600;
    }

    .filters {
      display: flex;
      gap: 10px;
      margin: 12px 0 16px;
    }

    .filters button {
      padding: 8px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.03);
      color: var(--muted);
      cursor: pointer;
      font-weight: 700;
      transition: background 0.2s ease, color 0.2s ease;
    }

    .filters button.active { color: var(--text); background: rgba(157, 107, 255, 0.15); border-color: rgba(157,107,255,0.5); }

    .list { display: flex; flex-direction: column; gap: 10px; flex: 1; min-height: 420px; }

    .friend-card {
      position: relative;
      display: grid;
      grid-template-columns: auto 1fr auto;
      gap: 12px;
      align-items: center;
      padding: 12px 12px;
      background: rgba(255, 255, 255, 0.02);
      border: 1px solid var(--border);
      border-radius: 14px;
      cursor: pointer;
      transition: border 0.2s ease, transform 0.12s ease, background 0.2s ease;
    }

    .friend-card:hover { transform: translateY(-1px); border-color: rgba(92, 240, 255, 0.35); background: rgba(92, 240, 255, 0.04); }

    .avatar {
      width: 40px;
      height: 40px;
      border-radius: 12px;
      background: linear-gradient(140deg, rgba(157, 107, 255, 0.2), rgba(92, 240, 255, 0.2));
      display: grid;
      place-items: center;
      font-weight: 800;
      color: var(--text);
    }

    .friend-meta { display: flex; flex-direction: column; gap: 4px; }
    .friend-name { font-weight: 800; letter-spacing: 0.1px; }
    .friend-status { color: var(--muted); font-size: 13px; display: flex; align-items: center; gap: 6px; }

    .dot { width: 10px; height: 10px; border-radius: 50%; }
    .dot.online { background: #4ce1b6; box-shadow: 0 0 0 6px rgba(76, 225, 182, 0.16); }
    .dot.offline { background: rgba(255,255,255,0.18); }
    .dot.blocked { background: var(--danger); box-shadow: 0 0 0 6px rgba(255,107,155,0.16); }

    .friend-actions {
      position: relative;
      opacity: 0;
      transition: opacity 0.12s ease;
    }

    .friend-card:hover .friend-actions { opacity: 1; }

    .action-btn {
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.03);
      color: var(--text);
      border-radius: 10px;
      padding: 8px 10px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: background 0.2s ease, border 0.2s ease;
    }

    .action-btn:hover { background: rgba(92, 240, 255, 0.1); border-color: rgba(92, 240, 255, 0.45); }

    .menu {
      position: absolute;
      right: 0;
      top: 44px;
      background: rgba(16, 19, 29, 0.96);
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: 0 18px 50px rgba(0,0,0,0.5);
      min-width: 150px;
      display: none;
      flex-direction: column;
      overflow: hidden;
      z-index: 10;
    }

    .menu button {
      border: none;
      background: none;
      color: var(--text);
      padding: 10px 12px;
      cursor: pointer;
      text-align: left;
      transition: background 0.2s ease;
    }

    .menu button:hover { background: rgba(255,255,255,0.05); }

    .empty {
      padding: 18px;
      border: 1px dashed var(--border);
      border-radius: 14px;
      color: var(--muted);
      text-align: center;
      line-height: 1.5;
    }

    .side-card h3 { margin-bottom: 8px; }
    .side-card p { color: var(--muted); line-height: 1.5; margin-bottom: 12px; }
    .side-list { display: flex; flex-direction: column; gap: 10px; }

    .mini-entry { display: flex; align-items: center; gap: 10px; color: var(--muted); font-weight: 700; }

    .tag { padding: 4px 8px; border-radius: 10px; background: rgba(255,255,255,0.05); border: 1px solid var(--border); font-size: 12px; }

    .profile-summary {
      background: linear-gradient(160deg, rgba(255,255,255,0.02), rgba(255,255,255,0.05));
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 16px;
      position: relative;
      overflow: hidden;
      box-shadow: 0 16px 50px rgba(0,0,0,0.4);
    }

    .profile-summary::after {
      content: '';
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at 20% 30%, rgba(157, 107, 255, 0.12), transparent 40%),
                  radial-gradient(circle at 80% 30%, rgba(92, 240, 255, 0.12), transparent 35%);
      opacity: 0.7;
      pointer-events: none;
    }

    .profile-summary .header {
      display: flex;
      align-items: center;
      gap: 12px;
      position: relative;
      z-index: 1;
    }

    .profile-summary .avatar {
      width: 58px;
      height: 58px;
      border-radius: 16px;
      background: linear-gradient(140deg, rgba(157, 107, 255, 0.2), rgba(92, 240, 255, 0.18));
      display: grid;
      place-items: center;
      font-weight: 900;
      font-size: 22px;
      color: var(--text);
      border: 1px solid rgba(255,255,255,0.06);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.05), 0 10px 30px rgba(0,0,0,0.35);
    }

    .profile-summary .identity { display: flex; flex-direction: column; gap: 4px; }
    .profile-summary .handle { color: var(--muted); font-size: 13px; }
    .profile-summary .status { font-size: 13px; color: var(--muted); display: flex; gap: 6px; align-items: center; }
    .profile-summary .status .dot { transform: translateY(1px); }

    .profile-summary .footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 14px;
      position: relative;
      z-index: 1;
    }

    .pill { padding: 6px 10px; border-radius: 12px; background: rgba(255,255,255,0.04); border: 1px solid var(--border); font-weight: 700; font-size: 12px; }

    .profile-summary .menu-btn {
      width: 36px;
      height: 36px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.04);
      color: var(--text);
      display: grid;
      place-items: center;
      cursor: pointer;
      transition: background 0.2s ease, border 0.2s ease, transform 0.2s ease;
    }

    .profile-summary .menu-btn:hover { background: rgba(92, 240, 255, 0.12); border-color: rgba(92, 240, 255, 0.45); transform: translateY(-1px); }

    .profile-summary .divider { height: 1px; background: var(--border); margin: 12px 0; position: relative; z-index: 1; }

    .toggle { display: flex; align-items: center; gap: 10px; color: var(--muted); font-size: 14px; }
    .toggle input { accent-color: #9d6bff; width: 18px; height: 18px; }

    .profile-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.55);
      backdrop-filter: blur(10px);
      display: grid;
      place-items: center;
      z-index: 60;
    }

    .profile-modal {
      width: min(920px, 94vw);
      background: rgba(14, 16, 26, 0.95);
      border: 1px solid var(--border);
      border-radius: 20px;
      display: grid;
      grid-template-columns: 220px 1fr;
      overflow: hidden;
      box-shadow: 0 26px 90px rgba(0,0,0,0.6);
      position: relative;
      padding-top: 8px;
    }

    .profile-modal .close-profile {
      position: absolute;
      top: 10px;
      right: 10px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.1), rgba(255,255,255,0.03));
      border: 1px solid var(--border);
      border-radius: 10px;
      color: var(--text);
      width: 38px;
      height: 38px;
      cursor: pointer;
      z-index: 5;
      box-shadow: 0 10px 28px rgba(0,0,0,0.45);
    }

    .profile-nav { background: rgba(19, 22, 32, 0.96); padding: 22px 18px; display: flex; flex-direction: column; gap: 10px; border-right: 1px solid var(--border); }
    .profile-nav h4 { margin-bottom: 10px; }
    .profile-nav button { width: 100%; justify-content: flex-start; background: rgba(255,255,255,0.03); border: 1px solid var(--border); color: var(--text); }

    .profile-body { padding: 24px 32px 24px 24px; display: grid; grid-template-columns: 1.2fr 0.9fr; gap: 24px; position: relative; }
    .profile-body .section { background: rgba(255,255,255,0.02); border: 1px solid var(--border); border-radius: 14px; padding: 16px; box-shadow: 0 16px 50px rgba(0,0,0,0.35); }
    .profile-body .section h5 { margin-bottom: 12px; }
    .profile-body .field { margin-bottom: 10px; color: var(--muted); }

    .row { display: flex; align-items: center; gap: 8px; color: var(--muted); }

    /* Modal */
    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.45);
      backdrop-filter: blur(8px);
      display: grid;
      place-items: center;
      z-index: 50;
    }

    .modal {
      width: min(420px, 92vw);
      background: rgba(16, 19, 29, 0.95);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 24px 70px rgba(0,0,0,0.55);
    }

    .modal h3 { margin-bottom: 10px; }
    .modal p { color: var(--muted); margin-bottom: 12px; }

    .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 12px; }
    .ghost { background: rgba(255,255,255,0.03); color: var(--text); border: 1px solid var(--border); }

    /* Chat view */
    .chat-layout {
      display: grid;
      grid-template-columns: 1.2fr 280px;
      gap: 16px;
      width: min(1100px, 96vw);
      height: 700px;
      align-items: stretch;
    }

    .chat-header { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
    .chat-header img { width: 40px; height: 40px; border-radius: 12px; cursor: pointer; }

    .chat-panel { display: flex; flex-direction: column; gap: 16px; height: 640px; }

    .messages {
      background: rgba(16, 19, 29, 0.92);
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 18px;
      display: flex;
      flex-direction: column;
      gap: 14px;
      flex: 1;
      min-height: 0;
      max-height: none;
      overflow-y: auto;
      overscroll-behavior: contain;
      scrollbar-width: thin;
      scrollbar-color: rgba(157, 107, 255, 0.5) rgba(255,255,255,0.05);
      box-shadow: 0 20px 60px rgba(0,0,0,0.45);
    }

    .messages::-webkit-scrollbar { width: 8px; }
    .messages::-webkit-scrollbar-thumb { background: linear-gradient(180deg, rgba(157,107,255,0.8), rgba(92,240,255,0.6)); border-radius: 8px; }
    .messages::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); border-radius: 10px; }

    .bubble {
      max-width: 70%;
      padding: 12px 14px;
      border-radius: 14px;
      line-height: 1.5;
    }
    .bubble.me { margin-left: auto; background: linear-gradient(140deg, #8e6bff, #5cf0ff); color: #0c0f18; font-weight: 700; }
    .bubble.them { background: rgba(255,255,255,0.04); border: 1px solid var(--border); }

    .timestamp { font-size: 12px; color: var(--muted); }

    .chat-form { display: flex; flex-direction: column; gap: 10px; }
    .chat-input { display: flex; gap: 10px; }
    .chat-input input {
      flex: 1;
      padding: 12px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.03);
      color: var(--text);
    }

    .block-warning { color: var(--danger); font-weight: 800; }

    .profile-card {
      background: rgba(16, 19, 29, 0.92);
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 18px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.45);
    }

    .profile-avatar {
      width: 82px;
      height: 82px;
      border-radius: 20px;
      background: linear-gradient(160deg, rgba(157, 107, 255, 0.24), rgba(92, 240, 255, 0.22));
      display: grid;
      place-items: center;
      font-size: 32px;
      font-weight: 900;
    }

    .blurred { filter: blur(6px); pointer-events: none; user-select: none; }
  </style>
</head>
<body>
  <div class="grain"></div>
  <div class="orb one"></div>
  <div class="orb two"></div>
  <div class="orb three"></div>

  <div class="app-shell" id="app">
    <section id="auth-view" class="card-wrap">
      <div class="splash" aria-hidden="true"></div>
      <div class="card" role="main">
        <div class="logo" aria-hidden="true">
          <img src="Images/Logo.png" alt="Logo NovaChat" />
        </div>
        <div>
          <h1 id="form-title">NovaChat</h1>
          <p class="subtitle" id="form-subtitle">Accedi o registra il tuo profilo con username e password: nessuna email richiesta.</p>
        </div>

        <form id="auth-form">
          <div>
            <label for="username">Username</label>
            <input id="username" class="input" name="username" autocomplete="username" required />
          </div>
          <div>
            <label for="password">Password</label>
            <input id="password" class="input" type="password" name="password" autocomplete="current-password" required />
          </div>
          <label class="toggle" for="stay-logged">
            <input type="checkbox" id="stay-logged" checked />
            <span>Rimani connesso</span>
          </label>
          <button type="submit" class="btn" id="submit-btn">Crea account</button>
          <div class="status" id="status"></div>
        </form>

        <div class="switcher">
          <span id="switch-copy">Hai già un account?</span>
          <button id="switch-btn" type="button">Accedi</button>
        </div>
      </div>
    </section>

    <section id="main-view" class="hidden">
      <div class="app-layout">
        <aside class="panel sidebar">
          <div class="brand">
            <img src="Images/Logo.png" alt="NovaChat" />
            <div class="name">NovaChat</div>
          </div>
          <ul class="nav">
            <li><button class="active">Friends</button></li>
            <li><button>Core Room</button></li>
            <li><button>Messages</button></li>
          </ul>
        </aside>

        <main class="panel main-panel">
          <div class="section-header">
            <div class="search">
              <input type="search" id="search" placeholder="Search" />
              <button class="btn" id="add-friend">Add Friend</button>
            </div>
          </div>
          <div class="filters" id="filters">
            <button data-filter="all" class="active">All</button>
            <button data-filter="online">Online</button>
            <button data-filter="pending">Pending</button>
            <button data-filter="blocked">Blocked</button>
          </div>
          <div class="list" id="friend-list"></div>
        </main>

        <aside class="panel side-card">
          <div class="profile-summary">
            <div class="header">
              <div class="avatar" id="side-avatar">N</div>
              <div class="identity">
                <div class="friend-name" id="side-name">Nova User</div>
                <div class="handle" id="side-handle">@utente</div>
                <div class="status" id="side-status"><span class="dot online"></span>Online</div>
              </div>
            </div>
            <div class="divider"></div>
            <div class="side-list" style="margin: 6px 0 0 0;">
              <div class="mini-entry"><span class="tag">ONLINE</span><span id="online-count">0</span></div>
              <div class="mini-entry"><span class="tag">OFFLINE</span><span id="offline-count">0</span></div>
            </div>
            <div class="footer">
              <span class="pill" id="member-since">Membro</span>
              <button class="menu-btn" id="open-profile" type="button">⋯</button>
            </div>
          </div>
          <div style="margin-top: 14px; display: flex; justify-content: space-between; gap: 10px; align-items: center;">
            <button class="btn" id="side-add" style="flex:1;">Send Friend Request</button>
          </div>
        </aside>
      </div>
    </section>

    <section id="chat-view" class="hidden">
      <div class="chat-layout">
        <div class="chat-panel">
          <div class="chat-header">
            <img src="Images/Logo.png" alt="Indietro a NovaChat" id="back-to-main" />
            <div>
              <div class="friend-name" id="chat-name">Chat</div>
              <div class="friend-status" id="chat-status"></div>
            </div>
          </div>
          <div class="messages" id="messages"></div>
          <form class="chat-form" id="chat-form">
            <div id="block-banner" class="block-warning hidden">Non puoi inviare messaggi all'utente</div>
            <div class="chat-input">
              <input type="text" id="chat-input" placeholder="Message @username" />
              <button type="submit" class="btn">Invia</button>
            </div>
          </form>
        </div>
        <aside class="profile-card">
          <div class="profile-avatar" id="profile-avatar">N</div>
          <div>
            <div class="friend-name" id="profile-name"></div>
            <div class="friend-status" id="profile-status"></div>
          </div>
          <div class="tag" id="profile-tag">Profilo</div>
          <div class="friend-status" id="profile-meta"></div>
        </aside>
      </div>
    </section>
  </div>

  <div id="modal" class="overlay hidden" role="dialog" aria-modal="true">
    <div class="modal">
      <h3>Aggiungi un amico</h3>
      <p>Inserisci il nickname del tuo amico per inviare la richiesta.</p>
      <input type="text" id="friend-name" class="input" placeholder="Nickname" />
      <div id="modal-status" class="status"></div>
      <div class="modal-actions">
        <button class="btn ghost" id="close-modal" type="button">Annulla</button>
        <button class="btn" id="confirm-add" type="button">Invia richiesta</button>
      </div>
    </div>
  </div>

  <div id="profile-overlay" class="profile-overlay hidden" role="dialog" aria-modal="true">
    <div class="profile-modal">
      <button class="close-profile" id="close-profile" type="button">×</button>
      <div class="profile-nav">
        <h4>Log out</h4>
        <button type="button" id="logout-btn">Esci e torna al login</button>
      </div>
      <div class="profile-body">
        <div class="section">
          <h5>User Profile</h5>
          <div class="row" style="margin-bottom: 12px;">
            <div class="profile-avatar" id="account-avatar">N</div>
            <div>
              <div class="friend-name" id="account-name">Nova User</div>
              <div class="friend-status" id="account-status"></div>
              <div class="handle" id="account-handle">@utente</div>
            </div>
          </div>
          <div class="field"><strong>About me:</strong> <span id="account-about">Sempre online su NovaChat.</span></div>
          <div class="field"><strong>Display name:</strong> <span id="account-display"></span></div>
          <div class="field"><strong>Username:</strong> <span id="account-username"></span></div>
        </div>
        <div class="section">
          <h5>Info</h5>
          <div class="field"><strong>Stato:</strong> <span id="account-state"></span></div>
          <div class="field"><strong>Member Since:</strong> <span id="account-member"></span></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const normalizeName = (value = '') => value.trim().replace(/^@+/, '');

    const DataStore = (() => {
      const USERS_KEY = 'novachat-users-v3';
      const loadUsers = () => {
        try {
          const raw = localStorage.getItem(USERS_KEY);
          if (!raw) return {};
          const parsed = JSON.parse(raw);
          return typeof parsed === 'object' && parsed ? parsed : {};
        } catch (err) {
          console.error('Impossibile leggere il DataStore', err);
          return {};
        }
      };

      const saveUsers = (users) => localStorage.setItem(USERS_KEY, JSON.stringify(users));
      let users = loadUsers();

      const reload = () => {
        users = loadUsers();
        return users;
      };

      const findUserKey = (name) => {
        const target = normalizeName(name);
        return Object.keys(users).find(u => u.toLowerCase() === target.toLowerCase());
      };
      const resolveUserKey = (name) => findUserKey(name) || name;

      const ensureUser = (username) => {
        if (!users[username]) {
          users[username] = { password: '', friends: [], pending: [], messages: {}, createdAt: new Date().toISOString(), status: 'offline' };
        }
        if (!users[username].createdAt) {
          users[username].createdAt = new Date().toISOString();
        }
        if (!users[username].status) {
          users[username].status = 'offline';
        }
      };

      const ensureFriendEntry = (owner, friendName) => {
        const ownerKey = resolveUserKey(owner);
        const friendKey = resolveUserKey(friendName);
        ensureUser(ownerKey);
        const user = users[ownerKey];
        const status = users[friendKey]?.status || 'offline';
        if (!user.friends.some(f => f.name.toLowerCase() === friendKey.toLowerCase())) {
          user.friends.push({ name: friendKey, status, pinned: false, blocked: false, messages: [] });
        }
        return user.friends.find(f => f.name.toLowerCase() === friendKey.toLowerCase());
      };

      return {
        register(username, password) {
          const clean = normalizeName(username);
          reload();
          const existing = findUserKey(clean);
          if (existing) {
            return { ok: false, message: 'Questo username è già in uso. Scegline un altro.' };
          }
          users[clean] = { password, friends: [], pending: [], messages: {}, createdAt: new Date().toISOString(), status: 'offline' };
          saveUsers(users);
          return { ok: true, user: clean };
        },
        exists(username) {
          reload();
          return Boolean(findUserKey(username));
        },
        login(username, password) {
          reload();
          const key = findUserKey(username);
          const user = key ? users[key] : null;
          if (!user || user.password !== password) {
            return { ok: false, message: 'Credenziali non valide. Ritenta.' };
          }
          return { ok: true, user: key };
        },
        getUser(username) {
          reload();
          const key = resolveUserKey(username);
          ensureUser(key);
          return users[key];
        },
        reload() {
          return reload();
        },
        setStatus(username, status) {
          const key = resolveUserKey(username);
          ensureUser(key);
          users[key].status = status;
          Object.keys(users).forEach(owner => {
            users[owner].friends = users[owner].friends.map(f => f.name.toLowerCase() === key.toLowerCase() ? { ...f, status } : f);
          });
          saveUsers(users);
        },
        addPending(sender, friendName) {
          reload();
          const senderKey = resolveUserKey(normalizeName(sender));
          ensureUser(senderKey);
          const targetKey = findUserKey(friendName);
          if (!targetKey) {
            return { ok: false, message: 'Utente non trovato.' };
          }
          const senderUser = users[senderKey];
          const target = users[targetKey];
          if (senderUser.friends.some(f => f.name.toLowerCase() === targetKey.toLowerCase()) ||
              target.friends.some(f => f.name.toLowerCase() === senderKey.toLowerCase())) {
            return { ok: false, message: 'Questo utente è già tra i tuoi amici.' };
          }
          if (target.pending.some(p => p.name.toLowerCase() === senderKey.toLowerCase())) {
            return { ok: false, message: 'Richiesta già inviata.' };
          }
          target.pending.push({ name: senderKey });
          saveUsers(users);
          return { ok: true };
        },
        accept(username, friendName) {
          reload();
          const ownerKey = resolveUserKey(username);
          const friendKey = resolveUserKey(friendName);
          ensureUser(ownerKey);
          ensureUser(friendKey);
          const user = users[ownerKey];
          const target = users[friendKey];
          user.pending = user.pending.filter(p => p.name.toLowerCase() !== friendKey.toLowerCase());
          const addEntry = (owner, other) => {
            const status = users[other]?.status || 'offline';
            if (!owner.friends.some(f => f.name === other)) {
              owner.friends.push({ name: other, status, pinned: false, blocked: false, messages: [] });
            }
          };
          addEntry(user, friendKey);
          addEntry(target, ownerKey);
          saveUsers(users);
        },
        decline(username, friendName) {
          reload();
          const ownerKey = resolveUserKey(username);
          const friendKey = resolveUserKey(friendName);
          ensureUser(ownerKey);
          const user = users[ownerKey];
          user.pending = user.pending.filter(p => p.name.toLowerCase() !== friendKey.toLowerCase());
          saveUsers(users);
        },
        toggleBlock(username, friendName) {
          reload();
          const ownerKey = resolveUserKey(username);
          const friendKey = resolveUserKey(friendName);
          ensureUser(ownerKey);
          const user = users[ownerKey];
          user.friends = user.friends.map(f => f.name.toLowerCase() === friendKey.toLowerCase() ? { ...f, blocked: !f.blocked } : f);
          saveUsers(users);
        },
        togglePin(username, friendName) {
          reload();
          const ownerKey = resolveUserKey(username);
          const friendKey = resolveUserKey(friendName);
          ensureUser(ownerKey);
          const user = users[ownerKey];
          user.friends = user.friends.map(f => f.name.toLowerCase() === friendKey.toLowerCase() ? { ...f, pinned: !f.pinned } : f);
          saveUsers(users);
        },
        removeFriend(username, friendName) {
          reload();
          const ownerKey = resolveUserKey(username);
          const friendKey = resolveUserKey(friendName);
          ensureUser(ownerKey);
          users[ownerKey].friends = users[ownerKey].friends.filter(f => f.name.toLowerCase() !== friendKey.toLowerCase());
          if (users[friendKey]) {
            users[friendKey].friends = users[friendKey].friends.filter(f => f.name.toLowerCase() !== ownerKey.toLowerCase());
          }
          saveUsers(users);
        },
        clearChat(username, friendName) {
          reload();
          const ownerKey = resolveUserKey(username);
          const friendKey = resolveUserKey(friendName);
          ensureUser(ownerKey);
          const wipeMessages = (owner, target) => {
            const user = users[owner];
            user.friends = user.friends.map(f => f.name.toLowerCase() === target.toLowerCase() ? { ...f, messages: [] } : f);
          };
          wipeMessages(ownerKey, friendKey);
          if (users[friendKey]) {
            wipeMessages(friendKey, ownerKey);
          }
          saveUsers(users);
        },
        saveMessage(sender, friendName, text) {
          reload();
          const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
          const senderKey = resolveUserKey(sender);
          const targetKey = resolveUserKey(friendName);
          ensureFriendEntry(senderKey, targetKey);
          const appendMessage = (owner, target, fromValue) => {
            const user = users[owner];
            user.friends = user.friends.map(f => {
              if (f.name.toLowerCase() !== target.toLowerCase()) return f;
              const nextMsgs = Array.isArray(f.messages) ? f.messages.slice() : [];
              nextMsgs.push({ from: fromValue, text, time });
              const nextStatus = f.blocked ? 'offline' : (f.status || 'online');
              return { ...f, messages: nextMsgs, status: nextStatus };
            });
          };

          appendMessage(senderKey, targetKey, senderKey);

          if (users[targetKey]) {
            ensureFriendEntry(targetKey, senderKey);
            appendMessage(targetKey, senderKey, senderKey);
          }

          saveUsers(users);
          return { delivered: Boolean(users[targetKey]) };
        }
      };
    })();

    const form = document.getElementById('auth-form');
    const status = document.getElementById('status');
    const switchBtn = document.getElementById('switch-btn');
    const switchCopy = document.getElementById('switch-copy');
    const submitBtn = document.getElementById('submit-btn');
    const title = document.getElementById('form-title');
    const subtitle = document.getElementById('form-subtitle');
    const usernameField = document.getElementById('username');
    const passwordField = document.getElementById('password');
    const stayLoggedToggle = document.getElementById('stay-logged');
    const splash = document.querySelector('.splash');

    const authView = document.getElementById('auth-view');
    const mainView = document.getElementById('main-view');
    const chatView = document.getElementById('chat-view');
    const friendList = document.getElementById('friend-list');
    const filters = document.getElementById('filters');
    const searchInput = document.getElementById('search');
    const onlineCount = document.getElementById('online-count');
    const offlineCount = document.getElementById('offline-count');
    const addFriendBtns = [document.getElementById('add-friend'), document.getElementById('side-add')];
    const modal = document.getElementById('modal');
    const modalStatus = document.getElementById('modal-status');
    const friendInput = document.getElementById('friend-name');
    const closeModal = document.getElementById('close-modal');
    const confirmAdd = document.getElementById('confirm-add');
    const appShell = document.getElementById('app');

    const sideAvatar = document.getElementById('side-avatar');
    const sideName = document.getElementById('side-name');
    const sideHandle = document.getElementById('side-handle');
    const sideStatus = document.getElementById('side-status');
    const memberSince = document.getElementById('member-since');
    const openProfile = document.getElementById('open-profile');
    const profileOverlay = document.getElementById('profile-overlay');
    const closeProfile = document.getElementById('close-profile');
    const logoutBtn = document.getElementById('logout-btn');

    const accountAvatar = document.getElementById('account-avatar');
    const accountName = document.getElementById('account-name');
    const accountStatus = document.getElementById('account-status');
    const accountHandle = document.getElementById('account-handle');
    const accountAbout = document.getElementById('account-about');
    const accountDisplay = document.getElementById('account-display');
    const accountUsername = document.getElementById('account-username');
    const accountState = document.getElementById('account-state');
    const accountMember = document.getElementById('account-member');

    const chatName = document.getElementById('chat-name');
    const chatStatus = document.getElementById('chat-status');
    const messagesEl = document.getElementById('messages');
    const chatForm = document.getElementById('chat-form');
    const chatInput = document.getElementById('chat-input');
    const blockBanner = document.getElementById('block-banner');
    const profileAvatar = document.getElementById('profile-avatar');
    const profileName = document.getElementById('profile-name');
    const profileStatus = document.getElementById('profile-status');
    const profileMeta = document.getElementById('profile-meta');
    const backToMain = document.getElementById('back-to-main');

    let mode = 'login';
    let currentUser = null;
    let filter = 'all';
    let activeFriend = null;
    let presenceInterval = null;
    let chatInterval = null;
    const presenceMap = {};
    const SESSION_KEY = 'novachat-session';

    function getStatus(friend) {
      if (!friend) return 'offline';
      const stored = presenceMap[friend.name];
      if (stored) return stored;
      if (friend.status) return friend.status;
      if (DataStore.exists(friend.name)) {
        const status = DataStore.getUser(friend.name).status || 'offline';
        presenceMap[friend.name] = status;
        return status;
      }
      return 'offline';
    }

    function formatDate(value) {
      const date = new Date(value);
      if (Number.isNaN(date.getTime())) return 'Nuovo membro';
      return date.toLocaleDateString('it-IT', { month: 'short', year: 'numeric' });
    }

    function persistSession(user, stay) {
      if (stay && user) {
        localStorage.setItem(SESSION_KEY, JSON.stringify({ user, stay: true }));
      } else {
        localStorage.removeItem(SESSION_KEY);
      }
    }

    function loadSession() {
      const raw = localStorage.getItem(SESSION_KEY);
      try {
        return raw ? JSON.parse(raw) : null;
      } catch (err) {
        return null;
      }
    }

    function triggerSplash() {
      splash.classList.remove('burst');
      void splash.offsetWidth;
      splash.classList.add('burst');
    }

    function setMode(next) {
      mode = next;
      const isSignup = mode === 'signup';
      title.textContent = 'NovaChat';
      subtitle.textContent = isSignup
        ? 'Crea il tuo account per entrare nella chat. Nessuna email, solo username e password.'
        : 'Accedi con il tuo username e la tua password.';
      submitBtn.textContent = isSignup ? 'Crea account' : 'Accedi';
      switchCopy.textContent = isSignup ? 'Hai già un account?' : 'Non hai ancora un account?';
      switchBtn.textContent = isSignup ? 'Accedi' : 'Registrati';
      status.textContent = '';
      status.className = 'status';
      usernameField.focus();
      triggerSplash();
    }

    form.addEventListener('submit', (event) => {
      event.preventDefault();
      const username = normalizeName(usernameField.value);
      const password = passwordField.value.trim();
      if (!username || !password) return;

      const action = mode === 'signup' ? DataStore.register : DataStore.login;
      const result = action(username, password);

      status.className = 'status ' + (result.ok ? 'success' : 'error');
      status.textContent = result.ok
        ? mode === 'signup'
          ? 'Account creato con successo. Benvenuto su NovaChat!'
          : 'Login effettuato con successo.'
        : result.message;

      if (result.ok) {
        passwordField.value = '';
        triggerSplash();
        currentUser = result.user || username;
        persistSession(currentUser, stayLoggedToggle.checked);
        showMain();
      }
    });

    switchBtn.addEventListener('click', () => {
      setMode(mode === 'signup' ? 'login' : 'signup');
    });

    splash.addEventListener('animationend', (event) => {
      if (event.animationName === 'splashBurst') {
        splash.classList.remove('burst');
      }
    });

    function renderUserSummary() {
      if (!currentUser) return;
      const user = DataStore.getUser(currentUser);
      sideAvatar.textContent = currentUser.charAt(0).toUpperCase();
      sideName.textContent = currentUser;
      sideHandle.textContent = '@' + currentUser.toLowerCase();
      sideStatus.innerHTML = '<span class="dot online"></span>Online';
      memberSince.textContent = user.createdAt ? 'Dal ' + formatDate(user.createdAt) : 'Nuovo membro';
    }

    function renderAccountPanel() {
      if (!currentUser) return;
      const user = DataStore.getUser(currentUser);
      const joined = user.createdAt ? formatDate(user.createdAt) : 'Nuovo membro';
      accountAvatar.textContent = currentUser.charAt(0).toUpperCase();
      accountName.textContent = currentUser;
      accountHandle.textContent = '@' + currentUser.toLowerCase();
      accountStatus.innerHTML = '<span class="dot online"></span>Online';
      accountDisplay.textContent = currentUser;
      accountUsername.textContent = currentUser;
      accountState.textContent = 'Online';
      accountMember.textContent = joined;
    }

    function showMain() {
      if (!currentUser) return;
      authView.classList.add('hidden');
      chatView.classList.add('hidden');
      mainView.classList.remove('hidden');
      profileOverlay.classList.add('hidden');
      appShell.classList.remove('blurred');
      DataStore.setStatus(currentUser, 'online');
      const user = DataStore.getUser(currentUser);
      user.friends.forEach(f => {
        presenceMap[f.name] = f.blocked ? 'offline' : (f.status || 'online');
      });
      startPresenceLoop();
      startChatSync();
      renderUserSummary();
      renderAccountPanel();
      renderFriends();
    }

    function logout() {
      if (currentUser) {
        DataStore.setStatus(currentUser, 'offline');
      }
      currentUser = null;
      activeFriend = null;
      clearInterval(presenceInterval);
      clearInterval(chatInterval);
      persistSession('', false);
      appShell.classList.remove('blurred');
      profileOverlay.classList.add('hidden');
      modal.classList.add('hidden');
      mainView.classList.add('hidden');
      chatView.classList.add('hidden');
      authView.classList.remove('hidden');
      usernameField.value = '';
      passwordField.value = '';
      stayLoggedToggle.checked = false;
      setMode('login');
    }

    function showChat(friend) {
      activeFriend = friend;
      mainView.classList.add('hidden');
      chatView.classList.remove('hidden');
      const statusValue = getStatus(friend) || 'offline';
      presenceMap[friend.name] = friend.blocked ? 'offline' : 'online';
      chatName.textContent = friend.name;
      chatStatus.innerHTML = `<span class="dot ${friend.blocked ? 'blocked' : statusValue}"></span>${friend.blocked ? 'Blocked' : (statusValue === 'online' ? 'Online' : 'Offline')}`;
      profileAvatar.textContent = friend.name.charAt(0).toUpperCase();
      profileName.textContent = friend.name;
      profileStatus.innerHTML = `<span class="dot ${friend.blocked ? 'blocked' : statusValue}"></span>${friend.blocked ? 'Bloccato' : (statusValue === 'online' ? 'Online' : 'Offline')}`;
      profileMeta.textContent = friend.pinned ? 'Fissato in alto' : 'Contatto standard';
      chatInput.placeholder = `Message @${friend.name}`;
      renderMessages(friend);
      const blocked = friend.blocked;
      blockBanner.classList.toggle('hidden', !blocked);
      chatInput.disabled = blocked;
    }

    function renderMessages(friend) {
      messagesEl.innerHTML = '';
      const msgs = Array.isArray(friend.messages) ? friend.messages : [];
      if (!msgs.length) {
        const empty = document.createElement('div');
        empty.className = 'empty';
        empty.textContent = 'La chat è vuota. Invia un messaggio per iniziare.';
        messagesEl.appendChild(empty);
        messagesEl.scrollTop = messagesEl.scrollHeight;
        return;
      }
      msgs.forEach(m => {
        const bubble = document.createElement('div');
        bubble.className = `bubble ${m.from === currentUser ? 'me' : 'them'}`;
        bubble.innerHTML = `<div>${m.text}</div><div class="timestamp">${m.time}</div>`;
        messagesEl.appendChild(bubble);
      });
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function syncActiveChat() {
      if (!activeFriend || chatView.classList.contains('hidden')) return;
      DataStore.reload();
      const user = DataStore.getUser(currentUser);
      const friend = user.friends.find(f => f.name === activeFriend.name);
      if (!friend) return;
      activeFriend = friend;
      const statusValue = getStatus(friend);
      chatStatus.innerHTML = `<span class="dot ${friend.blocked ? 'blocked' : statusValue}"></span>${friend.blocked ? 'Blocked' : (statusValue === 'online' ? 'Online' : 'Offline')}`;
      profileStatus.innerHTML = `<span class="dot ${friend.blocked ? 'blocked' : statusValue}"></span>${friend.blocked ? 'Bloccato' : (statusValue === 'online' ? 'Online' : 'Offline')}`;
      profileMeta.textContent = friend.pinned ? 'Fissato in alto' : 'Contatto standard';
      blockBanner.classList.toggle('hidden', !friend.blocked);
      chatInput.disabled = friend.blocked;
      renderMessages(friend);
    }

    chatForm.addEventListener('submit', (e) => {
      e.preventDefault();
      if (!activeFriend || chatInput.disabled) return;
      const text = chatInput.value.trim();
      if (!text) return;
      const result = DataStore.saveMessage(currentUser, activeFriend.name, text);
      const user = DataStore.getUser(currentUser);
      const updated = user.friends.find(f => f.name === activeFriend.name);
      chatInput.value = '';
      showChat(updated);
      if (!result.delivered) {
        console.warn('Messaggio non consegnato: utente destinatario non trovato.');
      }
    });

    backToMain.addEventListener('click', showMain);

    function renderFriends() {
      DataStore.reload();
      const user = DataStore.getUser(currentUser);
      const term = searchInput.value.trim().toLowerCase();
      const filtered = user.friends
        .filter(f => !term || f.name.toLowerCase().includes(term))
        .filter(f => {
          const statusValue = getStatus(f);
          if (filter === 'online') return statusValue === 'online' && !f.blocked;
          if (filter === 'pending') return false;
          if (filter === 'blocked') return f.blocked;
          return !f.blocked;
        })
        .sort((a, b) => Number(b.pinned) - Number(a.pinned));

      friendList.innerHTML = '';

      const pendingVisible = filter === 'pending';

      if (pendingVisible) {
        const emptyPending = user.pending.length === 0;
        if (emptyPending) {
          friendList.appendChild(makeEmpty('Nessuna richiesta in arrivo. Invia un invito da "Add Friend".'));
        } else {
          user.pending.forEach(p => {
            const card = document.createElement('div');
            card.className = 'friend-card';
            card.innerHTML = `
              <div class="avatar">${p.name.charAt(0).toUpperCase()}</div>
              <div class="friend-meta">
                <div class="friend-name">${p.name}</div>
                <div class="friend-status"><span class="dot online"></span>Richiesta in arrivo</div>
              </div>
              <div class="friend-actions" style="opacity:1; display:flex; gap:6px;">
                <button class="action-btn" data-accept="${p.name}">Accetta</button>
                <button class="action-btn" data-decline="${p.name}">Rifiuta</button>
              </div>
            `;
            friendList.appendChild(card);
          });
        }
      } else {
        if (!filtered.length) {
          friendList.appendChild(makeEmpty('Non hai ancora amici qui. Usa "Add Friend" per iniziare.'));
        } else {
          filtered.forEach(f => {
            const card = document.createElement('div');
            card.className = 'friend-card';
            card.dataset.friend = f.name;
            const statusValue = getStatus(f);
            const statusDot = f.blocked ? 'blocked' : statusValue;
            const statusLabel = f.blocked ? 'Bloccato' : (statusValue === 'online' ? 'Online' : 'Offline');
            card.innerHTML = `
              <div class="avatar">${f.name.charAt(0).toUpperCase()}</div>
              <div class="friend-meta">
                <div class="friend-name">${f.name}${f.pinned ? ' 📌' : ''}</div>
                <div class="friend-status"><span class="dot ${statusDot}"></span>${statusLabel}</div>
              </div>
                  <div class="friend-actions">
                    <button class="action-btn" type="button">⋯</button>
                    <div class="menu">
                      <button data-action="report" data-friend="${f.name}">Segnala</button>
                      <button data-action="block" data-friend="${f.name}">${f.blocked ? 'Sblocca' : 'Blocca'}</button>
                      <button data-action="pin" data-friend="${f.name}">${f.pinned ? 'Rimuovi fissato' : 'Fissa'}</button>
                      <button data-action="remove" data-friend="${f.name}">Rimuovi amicizia</button>
                      <button data-action="clear" data-friend="${f.name}">Cancella chat</button>
                    </div>
                  </div>
            `;
            friendList.appendChild(card);
          });
        }
      }

      onlineCount.textContent = user.friends.filter(f => getStatus(f) === 'online' && !f.blocked).length;
      offlineCount.textContent = user.friends.filter(f => getStatus(f) !== 'online' && !f.blocked).length;
    }

    function makeEmpty(text) {
      const empty = document.createElement('div');
      empty.className = 'empty';
      empty.textContent = text;
      return empty;
    }

    filters.addEventListener('click', (e) => {
      if (e.target.dataset.filter) {
        filter = e.target.dataset.filter;
        [...filters.querySelectorAll('button')].forEach(btn => btn.classList.toggle('active', btn.dataset.filter === filter));
        renderFriends();
      }
    });

    searchInput.addEventListener('input', renderFriends);

    friendList.addEventListener('click', (e) => {
      const accept = e.target.dataset.accept;
      const decline = e.target.dataset.decline;
      const action = e.target.dataset.action;
      const friendName = e.target.dataset.friend;
      const actionBtn = e.target.closest('.action-btn');

      if (actionBtn && actionBtn.nextElementSibling?.classList.contains('menu')) {
        const menu = actionBtn.nextElementSibling;
        const open = menu.style.display === 'flex';
        document.querySelectorAll('.menu').forEach(m => m.style.display = 'none');
        menu.style.display = open ? 'none' : 'flex';
        e.stopPropagation();
        return;
      }

      if (accept) {
        DataStore.accept(currentUser, accept);
        renderFriends();
        return;
      }
      if (decline) {
        DataStore.decline(currentUser, decline);
        renderFriends();
        return;
      }

      if (action && friendName) {
        if (action === 'block') {
          DataStore.toggleBlock(currentUser, friendName);
        }
        if (action === 'pin') {
          DataStore.togglePin(currentUser, friendName);
        }
        if (action === 'report') {
          alert('Segnalazione inviata per ' + friendName);
        }
        if (action === 'remove') {
          DataStore.removeFriend(currentUser, friendName);
          if (activeFriend && activeFriend.name === friendName) {
            activeFriend = null;
            showMain();
          }
        }
        if (action === 'clear') {
          DataStore.clearChat(currentUser, friendName);
          if (activeFriend && activeFriend.name === friendName) {
            const user = DataStore.getUser(currentUser);
            const refreshed = user.friends.find(f => f.name === friendName);
            if (refreshed) showChat(refreshed);
          }
        }
        renderFriends();
        return;
      }

      const card = e.target.closest('.friend-card');
      if (!card || filter === 'pending') return;
      const name = card.dataset.friend;
      if (!name) return;
      const user = DataStore.getUser(currentUser);
      const friend = user.friends.find(f => f.name === name);
      if (friend) {
        showChat(friend);
      }
    });

    friendList.addEventListener('mouseleave', () => {
      document.querySelectorAll('.menu').forEach(m => m.style.display = 'none');
    });

    addFriendBtns.forEach(btn => btn.addEventListener('click', () => {
      modal.classList.remove('hidden');
      appShell.classList.add('blurred');
      modalStatus.textContent = '';
      modalStatus.className = 'status';
      friendInput.value = '';
      friendInput.focus();
    }));

    closeModal.addEventListener('click', () => {
      modal.classList.add('hidden');
      appShell.classList.remove('blurred');
    });

    confirmAdd.addEventListener('click', () => {
      const name = normalizeName(friendInput.value);
      if (!name) return;
      if (name.toLowerCase() === currentUser.toLowerCase()) {
        modalStatus.className = 'status error';
        modalStatus.textContent = 'Non puoi aggiungere te stesso.';
        return;
      }
      const result = DataStore.addPending(currentUser, name);
      modalStatus.className = 'status ' + (result.ok ? 'success' : 'error');
      modalStatus.textContent = result.ok ? `Richiesta inviata a ${name}.` : result.message;
      if (result.ok) {
        renderFriends();
        setTimeout(() => {
          modal.classList.add('hidden');
          appShell.classList.remove('blurred');
        }, 600);
      }
    });

    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        modal.classList.add('hidden');
        appShell.classList.remove('blurred');
      }
    });

    openProfile.addEventListener('click', () => {
      renderAccountPanel();
      profileOverlay.classList.remove('hidden');
      appShell.classList.add('blurred');
    });

    closeProfile.addEventListener('click', () => {
      profileOverlay.classList.add('hidden');
      appShell.classList.remove('blurred');
    });

    profileOverlay.addEventListener('click', (e) => {
      if (e.target === profileOverlay) {
        profileOverlay.classList.add('hidden');
        appShell.classList.remove('blurred');
      }
    });

    logoutBtn.addEventListener('click', logout);

    function restoreSession() {
      const saved = loadSession();
      if (saved?.user && saved.stay && DataStore.exists(saved.user)) {
        currentUser = saved.user;
        showMain();
        return true;
      }
      if (saved?.user) {
        usernameField.value = saved.user;
        stayLoggedToggle.checked = Boolean(saved.stay);
      }
      return false;
    }

    function startPresenceLoop() {
      clearInterval(presenceInterval);
      presenceInterval = setInterval(() => {
        if (!currentUser) return;
        DataStore.reload();
        const user = DataStore.getUser(currentUser);
        user.friends.forEach(f => {
          presenceMap[f.name] = f.blocked ? 'offline' : (f.status || presenceMap[f.name] || 'online');
        });
        renderFriends();
        syncActiveChat();
      }, 3200);
    }

    function startChatSync() {
      clearInterval(chatInterval);
      chatInterval = setInterval(syncActiveChat, 1200);
    }

    function handleStorageSync() {
      if (!currentUser) return;
      DataStore.reload();
      renderUserSummary();
      renderAccountPanel();
      renderFriends();
      syncActiveChat();
    }

    window.addEventListener('storage', handleStorageSync);
    window.addEventListener('beforeunload', () => {
      if (currentUser) {
        DataStore.setStatus(currentUser, 'offline');
      }
    });

    const booted = restoreSession();
    if (!booted) {
      setMode(mode);
    }
  </script>
</body>
</html>
